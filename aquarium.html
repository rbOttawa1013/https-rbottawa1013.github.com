<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Aquarium (Food, Time of Day, Phytoplankton Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0077cc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        canvas {
            display: block;
            background-color: #e0e0e0; /* Light grey fallback for visibility */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .control-button { /* Common style for top-right buttons */
            position: absolute;
            right: 20px;
            padding: 10px 15px;
            background-color: rgba(0, 50, 100, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 150px; /* Ensure buttons have same width */
            text-align: center;
        }
        .control-button:hover {
            background-color: rgba(0, 70, 120, 0.9);
        }
        #settingsButton {
            top: 20px;
        }
        #feedingButton {
            top: 70px; /* Position below settings */
        }
        #timeOfDayButton {
            top: 120px; /* Position below feeding */
        }

        #settingsPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 480px; 
            max-height: 85vh; 
            overflow-y: auto; 
            background-color: rgba(240, 245, 250, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none; 
            color: #333;
        }
        #settingsPanel h2 { margin-top: 0; margin-bottom: 20px; color: #003366; text-align: center; }
        .setting-group { margin-bottom: 18px; }
        .setting-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #004c99; }
        .setting-group input[type="range"],
        .setting-group select { width: calc(100% - 70px); padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; background-color: #fff; }
        .setting-group input[type="range"] { display: inline-block; vertical-align: middle; }
        .setting-group .value-display { display: inline-block; width: 50px; text-align: right; margin-left: 10px; font-weight: bold; color: #003366; vertical-align: middle; }
        .setting-group input[type="checkbox"] { margin-right: 8px; vertical-align: middle; }
        #applySettingsButton { display: block; width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 25px; }
        #applySettingsButton:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <button id="settingsButton" class="control-button">Settings</button>
    <button id="feedingButton" class="control-button">Drop Food</button>
    <button id="timeOfDayButton" class.control-button">Toggle Time of Day</button>

    <div id="settingsPanel">
        <h2>Aquarium Settings</h2>
        <div class="setting-group">
            <label for="bubblesAmount">Amount of Bubbles:</label>
            <input type="range" id="bubblesAmount" min="0" max="200" value="50">
            <span class="value-display" id="bubblesAmountValue">50</span>
        </div>
        <div class="setting-group">
            <label for="seaweedAmount">Amount of Seaweed:</label>
            <input type="range" id="seaweedAmount" min="0" max="100" value="20">
            <span class="value-display" id="seaweedAmountValue">20</span>
        </div>
        <div class="setting-group">
            <label for="phytoplanktonAmount">Glowing Phytoplankton (0-1000):</label>
            <input type="range" id="phytoplanktonAmount" min="0" max="1000" value="20">
            <span class="value-display" id="phytoplanktonAmountValue">20</span>
        </div>
        <div class="setting-group">
            <label for="fishSchools">Number of Fish Schools:</label>
            <input type="range" id="fishSchools" min="0" max="10" value="2">
            <span class="value-display" id="fishSchoolsValue">2</span>
        </div>
        <div class="setting-group">
            <label for="independentFish">Number of Independent Fish:</label>
            <input type="range" id="independentFish" min="0" max="50" value="10">
            <span class="value-display" id="independentFishValue">10</span>
        </div>
        <div class="setting-group">
            <label for="sharksAmount">Number of Sharks (0-8):</label>
            <input type="range" id="sharksAmount" min="0" max="8" value="1">
            <span class="value-display" id="sharksAmountValue">1</span>
        </div>
        <div class="setting-group">
            <label for="shipStyle">Style of Sunken Ship:</label>
            <select id="shipStyle">
                <option value="default">Default Wreck</option>
                <option value="pirate_ship">Pirate Ship</option>
                <option value="submarine">Submarine</option>
                <option value="spanish_galleon">Spanish Galleon</option>
                <option value="ufo">UFO (Saucer)</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="sandColor">Sand Color:</label>
            <select id="sandColor">
                <option value="default">Default Sand</option>
                <option value="mixed_sparkling">Mixed Sparkling</option>
                <option value="mixed_color_grains">Mixed Color Grains</option>
            </select>
        </div>
         <div class="setting-group">
            <label for="timeOfDayDuration">Time of Day Duration (s):</label>
            <input type="range" id="timeOfDayDuration" min="0" max="120" value="60">
            <span class="value-display" id="timeOfDayDurationValue">60</span>
        </div>
        <div class="setting-group">
            <label for="bubbleSound">Bubble Touch Sound:</label>
            <input type="checkbox" id="bubbleSound"> On
        </div>
        <button id="applySettingsButton">Apply & Close</button>
    </div>

    <canvas id="aquariumCanvas"></canvas>

    <script>
    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed. Initializing Aquarium App...");

        const canvas = document.getElementById('aquariumCanvas');
        if (!canvas) {
            console.error("FATAL ERROR: Canvas element with ID 'aquariumCanvas' not found.");
            return; 
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error("FATAL ERROR: Failed to get 2D rendering context for the canvas.");
            return; 
        }
        
        const settingsButton = document.getElementById('settingsButton');
        const feedingButton = document.getElementById('feedingButton'); // New button
        const timeOfDayButton = document.getElementById('timeOfDayButton'); // New button
        const settingsPanel = document.getElementById('settingsPanel');
        const applySettingsButton = document.getElementById('applySettingsButton');
        const bubblesAmountSlider = document.getElementById('bubblesAmount');
        const seaweedAmountSlider = document.getElementById('seaweedAmount');
        const phytoplanktonAmountSlider = document.getElementById('phytoplanktonAmount'); 
        const fishSchoolsSlider = document.getElementById('fishSchools');
        const independentFishSlider = document.getElementById('independentFish');
        const sharksAmountSlider = document.getElementById('sharksAmount');
        const shipStyleSelect = document.getElementById('shipStyle');
        const sandColorSelect = document.getElementById('sandColor');
        const timeOfDayDurationSlider = document.getElementById('timeOfDayDuration'); // New slider
        const bubbleSoundCheckbox = document.getElementById('bubbleSound');
        const bubblesAmountValueDisplay = document.getElementById('bubblesAmountValue');
        const seaweedAmountValueDisplay = document.getElementById('seaweedAmountValue');
        const phytoplanktonAmountValueDisplay = document.getElementById('phytoplanktonAmountValue'); 
        const fishSchoolsValueDisplay = document.getElementById('fishSchoolsValue');
        const independentFishValueDisplay = document.getElementById('independentFishValue');
        const sharksAmountValueDisplay = document.getElementById('sharksAmountValue');
        const timeOfDayDurationValueDisplay = document.getElementById('timeOfDayDurationValue'); // New display

        let aquariumSettings = {
            numBubbles: 50, numSeaweed: 20, numPhytoplankton: 20, 
            numFishSchools: 2, numIndependentFish: 10,
            numSharks: 1, shipStyle: 'default', sandColor: 'default', 
            timeOfDayDuration: 60, // seconds
            currentTimeOfDay: 'day', // 'day', 'dusk', 'night', 'dawn'
            playBubbleTouchSound: false
        };

        let fishArray = [], seaweedArray = [], coralArray = [], bubbleArray = [],
            crabArray = [], fishSchoolArray = [], sharkArray = [], phytoplanktonArray = [],
            foodParticlesArray = [], // For food
            shipwreck;
        let animationFrameId; 
        const SEABED_OFFSET_FACTOR = 0.15;
        let time = 0; 
        let timeOfDayTimer = 0; // Timer for automatic time of day change

        let soundSynth;
        let lastSoundTime = 0;
        const SOUND_COOLDOWN = 100; 

        function random(min, max) { return Math.random() * (max - min) + min; }
        function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function drawBackground() {
            let gradColors = {
                day: ['#3A9FBF', '#0E5A8A', '#053C5E'],
                dusk: ['#FF8C42', '#E85A4F', '#3E2F5B'], // Orange/Red to Dark Purple
                night: ['#0B132B', '#1C2541', '#03071E'], // Very Dark Blues
                dawn: ['#FFCB77', '#F8B195', '#6D597A']  // Soft Yellow/Pink to Purple
            };
            let currentColors = gradColors[aquariumSettings.currentTimeOfDay] || gradColors.day;

            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, currentColors[0]); 
            gradient.addColorStop(0.7, currentColors[1]); 
            gradient.addColorStop(1, currentColors[2]); 
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const sandHeight = canvas.height * SEABED_OFFSET_FACTOR;
            ctx.fillStyle = '#D2B48C'; ctx.beginPath();
            ctx.moveTo(0, canvas.height); ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(canvas.width, canvas.height - sandHeight + 20);
            ctx.quadraticCurveTo(canvas.width*0.75, canvas.height-sandHeight-10, canvas.width*0.5, canvas.height-sandHeight+15);
            ctx.quadraticCurveTo(canvas.width*0.25, canvas.height-sandHeight+30, 0, canvas.height-sandHeight+10);
            ctx.closePath(); ctx.fill();
            if (aquariumSettings.sandColor === 'mixed_color_grains') {
                const grainColors = ['#C1A67C', '#B0936A', '#E0C9A6'];
                for (let k = 0; k < 3; k++) {
                    ctx.fillStyle = grainColors[k % grainColors.length] + '80'; ctx.beginPath();
                    const yOff = k*5*(canvas.height/800), xOff = k*3*(canvas.width/1000);
                    ctx.moveTo(0+xOff, canvas.height+yOff); ctx.lineTo(canvas.width+xOff, canvas.height+yOff);
                    ctx.lineTo(canvas.width+xOff, canvas.height-sandHeight+20+yOff);
                    ctx.quadraticCurveTo(canvas.width*0.75+xOff, canvas.height-sandHeight-10+yOff, canvas.width*0.5+xOff, canvas.height-sandHeight+15+yOff);
                    ctx.quadraticCurveTo(canvas.width*0.25+xOff, canvas.height-sandHeight+30+yOff, 0+xOff, canvas.height-sandHeight+10+yOff);
                    ctx.closePath(); ctx.fill();
                }
            }
            drawSeabedDetails();
            if (aquariumSettings.sandColor === 'mixed_sparkling') {
                const numSparkles = 100 * (canvas.width/1000);
                for (let i = 0; i < numSparkles; i++) {
                    const x = random(0, canvas.width); const yBase = canvas.height - sandHeight;
                    const curveAmp = 15*(canvas.height/800), curveOff = 15*(canvas.height/800);
                    const normX = x/canvas.width;
                    const sandCurveY = yBase + curveOff + Math.sin(normX*Math.PI*2 - Math.PI/2)*curveAmp;
                    const y = random(sandCurveY-(5*(canvas.height/800)), sandCurveY+(15*(canvas.height/800)));
                    if (y > yBase-(10*(canvas.height/800)) && y < canvas.height) { 
                        ctx.fillStyle = `rgba(255,255,230,${random(0.3,0.8)})`; ctx.beginPath();
                        ctx.arc(x,y,random(0.5,1.5)*(canvas.height/800),0,Math.PI*2); ctx.fill();
                    }
                }
            }
        }
        function drawSeabedDetails() {
            const sandHeight = canvas.height * SEABED_OFFSET_FACTOR;
            ctx.fillStyle = 'rgba(0,0,0,0.08)'; ctx.beginPath();
            ctx.ellipse(canvas.width*0.2,canvas.height-sandHeight+25,canvas.width*0.07,canvas.height*0.02,0,0,Math.PI*2); ctx.fill();
            ctx.beginPath();
            ctx.ellipse(canvas.width*0.8,canvas.height-sandHeight+30,canvas.width*0.1,canvas.height*0.025,0,0,Math.PI*2); ctx.fill();
        }
        
        class Shipwreck { 
            constructor(style) {
                this.style = style; const sf = Math.min(canvas.width/1000, canvas.height/800);
                this.baseWidth=(this.style==='submarine'?450:(this.style==='ufo'?300:350))*sf; 
                this.baseHeight=(this.style==='submarine'?120:(this.style==='ufo'?100:240))*sf;
                this.x=canvas.width/2-this.baseWidth/2.2; 
                this.y=canvas.height-(canvas.height*SEABED_OFFSET_FACTOR)-this.baseHeight*(this.style==='submarine'?0.5:(this.style==='ufo'?0.6:0.8));
                this.color='#5A4D3C'; this.detailColor='#40382D'; this.metalColor='#707070'; this.darkMetalColor='#404040';
                this.ufoLightColor = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00']; 
                this.ufoLightState = 0;
                this.ufoLightTimer = 0;
            }
            draw(){ctx.save();ctx.translate(this.x,this.y);switch(this.style){case 'pirate_ship':this.drawPirateShip();break;case 'submarine':this.drawSubmarine();break;case 'spanish_galleon':this.drawSpanishGalleon();break;case 'ufo':this.drawUFO();break;default:this.drawDefaultWreck();}ctx.restore();}
            drawDefaultWreck(){ctx.fillStyle=this.color;ctx.beginPath();ctx.moveTo(0,this.baseHeight*0.5);ctx.lineTo(this.baseWidth*0.4,this.baseHeight*0.3);ctx.lineTo(this.baseWidth*0.7,this.baseHeight*0.4);ctx.lineTo(this.baseWidth,this.baseHeight*0.8);ctx.lineTo(this.baseWidth*0.9,this.baseHeight);ctx.lineTo(this.baseWidth*0.1,this.baseHeight*1.1);ctx.closePath();ctx.fill();ctx.fillStyle=this.detailColor;ctx.fillRect(this.baseWidth*0.15,this.baseHeight*0.55,this.baseWidth*0.6,this.baseHeight*0.1);ctx.fillRect(this.baseWidth*0.2,this.baseHeight*0.7,this.baseWidth*0.5,this.baseHeight*0.08);ctx.beginPath();ctx.moveTo(this.baseWidth*0.45,this.baseHeight*0.3);ctx.lineTo(this.baseWidth*0.4,0);ctx.lineTo(this.baseWidth*0.43,0);ctx.lineTo(this.baseWidth*0.48,this.baseHeight*0.3);ctx.closePath();ctx.fill();}
            drawPirateShip(){ctx.fillStyle=this.color;ctx.beginPath();ctx.moveTo(0,this.baseHeight*0.4);ctx.quadraticCurveTo(this.baseWidth*0.2,this.baseHeight*0.2,this.baseWidth*0.5,this.baseHeight*0.3);ctx.lineTo(this.baseWidth*0.8,this.baseHeight*0.5);ctx.lineTo(this.baseWidth*0.75,this.baseHeight);ctx.lineTo(this.baseWidth*0.1,this.baseHeight*1.1);ctx.closePath();ctx.fill();ctx.fillStyle=this.detailColor;ctx.fillRect(this.baseWidth*0.3,this.baseHeight*0.1,this.baseWidth*0.08,-this.baseHeight*0.4);ctx.fillRect(this.baseWidth*0.6,this.baseHeight*0.3,this.baseWidth*0.06,-this.baseHeight*0.3);ctx.fillStyle='#222';ctx.beginPath();ctx.arc(this.baseWidth*0.4,this.baseHeight*0.5,this.baseHeight*0.05,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(this.baseWidth*0.6,this.baseHeight*0.6,this.baseHeight*0.05,0,Math.PI*2);ctx.fill();}
            drawSubmarine(){ctx.fillStyle=this.metalColor;ctx.beginPath();ctx.ellipse(this.baseWidth/2,this.baseHeight/2,this.baseWidth/2,this.baseHeight/2,0,0,Math.PI*2);ctx.fill();ctx.fillStyle=this.darkMetalColor;ctx.fillRect(this.baseWidth*0.4,0,this.baseWidth*0.2,this.baseHeight*0.5);ctx.beginPath();ctx.moveTo(this.baseWidth*0.95,this.baseHeight/2);ctx.lineTo(this.baseWidth*1.05,this.baseHeight*0.4);ctx.lineTo(this.baseWidth*1.05,this.baseHeight*0.6);ctx.closePath();ctx.fill();ctx.fillStyle='rgba(0,0,0,0.3)';for(let i=0;i<5;i++){ctx.beginPath();ctx.arc(this.baseWidth*0.1+i*this.baseWidth*0.18,this.baseHeight*0.5,3*(this.baseHeight/200),0,Math.PI*2);ctx.fill();}}
            drawSpanishGalleon(){ctx.fillStyle=this.color;ctx.beginPath();ctx.moveTo(0,this.baseHeight*0.5);ctx.quadraticCurveTo(this.baseWidth*0.2,this.baseHeight*0.3,this.baseWidth*0.4,this.baseHeight*0.4);ctx.lineTo(this.baseWidth*0.7,this.baseHeight*0.2);ctx.lineTo(this.baseWidth*0.9,this.baseHeight*0.3);ctx.lineTo(this.baseWidth*0.85,this.baseHeight*0.8);ctx.lineTo(this.baseWidth*0.1,this.baseHeight);ctx.closePath();ctx.fill();ctx.fillStyle=this.detailColor;ctx.fillRect(this.baseWidth*0.75,this.baseHeight*0.35,this.baseWidth*0.1,this.baseHeight*0.1);ctx.fillRect(this.baseWidth*0.75,this.baseHeight*0.5,this.baseWidth*0.1,this.baseHeight*0.1);ctx.fillRect(this.baseWidth*0.25,this.baseHeight*0.2,this.baseWidth*0.07,-this.baseHeight*0.3);ctx.fillRect(this.baseWidth*0.5,this.baseHeight*0.1,this.baseWidth*0.08,-this.baseHeight*0.4);}
            drawUFO() {
                ctx.fillStyle = this.metalColor; 
                ctx.beginPath(); ctx.ellipse(this.baseWidth/2,this.baseHeight*0.6,this.baseWidth/2,this.baseHeight/3,0,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = this.darkMetalColor; 
                ctx.beginPath(); ctx.ellipse(this.baseWidth/2,this.baseHeight*0.65,this.baseWidth/2,this.baseHeight/3.5,0,0,Math.PI); ctx.fill();
                ctx.fillStyle = '#A0D2DB'; 
                ctx.beginPath(); ctx.arc(this.baseWidth/2,this.baseHeight*0.35,this.baseWidth/4,Math.PI,0); ctx.closePath(); ctx.fill();
                ctx.strokeStyle = this.darkMetalColor; ctx.lineWidth = 2*(this.baseWidth/300); ctx.stroke();
                this.ufoLightTimer++;
                if (this.ufoLightTimer > 20) { this.ufoLightTimer=0; this.ufoLightState=(this.ufoLightState+1)%this.ufoLightColor.length; }
                const numLights=8; for(let i=0;i<numLights;i++){
                    const angle=(Math.PI*2/numLights)*i; const lightX=this.baseWidth/2+Math.cos(angle)*(this.baseWidth/2.2); const lightY=this.baseHeight*0.6+Math.sin(angle)*(this.baseHeight/3.3);
                    ctx.beginPath(); ctx.arc(lightX,lightY,this.baseWidth/30,0,Math.PI*2);
                    if(i===this.ufoLightState||(i+numLights/2)%numLights===this.ufoLightState){ctx.fillStyle=this.ufoLightColor[this.ufoLightState%this.ufoLightColor.length];ctx.shadowBlur=5;ctx.shadowColor=this.ufoLightColor[this.ufoLightState%this.ufoLightColor.length];}
                    else{ctx.fillStyle=this.darkMetalColor;ctx.shadowBlur=0;}
                    ctx.fill(); ctx.shadowBlur=0;
                }
            }
        }
        class Coral { 
            constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.baseSizeRef=random(canvas.height*0.03,canvas.height*0.08);this.colors={brain:['#FF7F50','#FF6347','#F08080'],fan:['#DA70D6','#DB7093','#BA55D3'],tube:['#ADFF2F','#7FFF00','#32CD32']};this.color=this.colors[type][randomInt(0,this.colors[type].length-1)];}
            get size(){return this.baseSizeRef*(Math.min(canvas.width,canvas.height)/800);}
            draw(){ctx.fillStyle=this.color;ctx.beginPath();const cs=this.size;switch(this.type){case 'brain':ctx.arc(this.x,this.y,cs,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(0,0,0,0.1)';for(let i=0;i<5;i++){ctx.beginPath();ctx.arc(this.x+random(-cs/2,cs/2),this.y+random(-cs/2,cs/2),cs/5,0,Math.PI*2);ctx.fill();}break;case 'fan':ctx.moveTo(this.x,this.y);ctx.ellipse(this.x,this.y-cs,cs*1.2,cs,Math.PI/random(3,5),Math.PI,Math.PI*2);ctx.closePath();ctx.fill();break;case 'tube':for(let i=0;i<3;i++){ctx.beginPath();const tH=cs*random(0.8,1.5);const tW=cs*0.3;ctx.ellipse(this.x+(i-1)*tW*1.2,this.y-tH/2,tW/2,tH/2,0,0,Math.PI*2);ctx.fill();}break;}}
        }
        class Phytoplankton { 
            constructor(){this.x=random(0,canvas.width);this.y=random(0,canvas.height*(1-SEABED_OFFSET_FACTOR-0.05));this.baseSize=random(0.5,1.5);this.flashColors=['#FF4444','#44AAFF','#44FF44'];this.defaultColor='rgba(200,220,255,0.1)';this.currentColor=this.defaultColor;this.isFlashing=false;this.flashDuration=0;this.flashCooldown=random(50,250);this.driftX=random(-0.1,0.1);this.driftY=random(-0.1,0.1);}
            get size(){return this.baseSize*(Math.min(canvas.width,canvas.height)/800);}
            update(){this.x+=this.driftX*(canvas.width/1000);this.y+=this.driftY*(canvas.height/800);if(this.x<0)this.x=canvas.width;if(this.x>canvas.width)this.x=0;if(this.y<0)this.y=canvas.height*(1-SEABED_OFFSET_FACTOR-0.05);if(this.y>canvas.height*(1-SEABED_OFFSET_FACTOR-0.05))this.y=0;if(this.isFlashing){this.flashDuration--;if(this.flashDuration<=0){this.isFlashing=false;this.currentColor=this.defaultColor;this.flashCooldown=random(100,600);}}else{this.flashCooldown--;if(this.flashCooldown<=0){if(Math.random()<0.02){this.isFlashing=true;this.flashDuration=random(15,40);this.currentColor=this.flashColors[randomInt(0,this.flashColors.length-1)];}else{this.flashCooldown=random(10,50);}}}}
            draw(){ctx.fillStyle=this.currentColor;if(this.isFlashing){ctx.shadowColor=this.currentColor;ctx.shadowBlur=5+this.size*2;}else{ctx.shadowBlur=0;}ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
        }
        class FoodParticle { // New FoodParticle class
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = random(2, 4) * (Math.min(canvas.width, canvas.height) / 800);
                this.speedY = random(0.2, 0.5) * (canvas.height / 800);
                this.speedX = random(-0.1, 0.1) * (canvas.width / 1000);
                this.color = 'rgba(180, 140, 100, 0.8)'; // Brownish food color
                this.opacity = 1;
            }
            update() {
                this.y += this.speedY;
                this.x += this.speedX;
                this.opacity -= 0.005; // Slowly fade out
            }
            draw() {
                if (this.opacity <= 0) return;
                ctx.fillStyle = `rgba(180, 140, 100, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        class Shark {
            constructor(){this.baseSizeRef=canvas.height*0.08;this.x=random(0,canvas.width);const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;const tS=this._calculateScaledSize(this.baseSizeRef);this.y=random(sP+tS.height/2,sL-tS.height/2);this.targetX=this.x;this.targetY=this.y;this.speed=random(0.8,1.8);this.turnSpeed=random(0.01,0.03);this.angle=random(0,Math.PI*2);this.actionTimer=random(150,300);this.bodyColor=`hsl(210,15%,${randomInt(40,55)}%)`;this.underbellyColor=`hsl(210,10%,70%)`;this.finColor=`hsl(210,15%,35%)`;this.eyeSizeFactor=0.06;this.tailAmplitude=random(8,15);this.tailFrequency=random(0.15,0.3);this.currentTailSway=0;}
            _calculateScaledSize(baseSize){const sf=Math.min(canvas.width,canvas.height)/1000;return{width:baseSize*2.5*sf,height:baseSize*0.6*sf};}
            get scaledSize(){return this._calculateScaledSize(this.baseSizeRef);}
            update(time){this.actionTimer--;const cS=this.speed*(canvas.width/1000);if(this.actionTimer<=0){const wR=200*(canvas.width/1000);this.targetX=this.x+random(-wR,wR);this.targetY=this.y+random(-wR,wR);const{width:sW,height:sH}=this.scaledSize;const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;this.targetX=Math.max(sW/2,Math.min(this.targetX,canvas.width-sW/2));this.targetY=Math.max(sP+sH/2,Math.min(this.targetY,sL-sH/2));this.actionTimer=random(150,300);}const dX=this.targetX-this.x;const dY=this.targetY-this.y;const tA=Math.atan2(dY,dX);let aD=tA-this.angle;while(aD>Math.PI)aD-=Math.PI*2;while(aD<-Math.PI)aD+=Math.PI*2;this.angle+=aD*this.turnSpeed;this.x+=Math.cos(this.angle)*cS;this.y+=Math.sin(this.angle)*cS;const{width:sW,height:sH}=this.scaledSize;if(this.x<-sW)this.x=canvas.width+sW;if(this.x>canvas.width+sW)this.x=-sW;const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;if(this.y<sP+sH/2){this.y=sP+sH/2;this.angle=Math.PI-this.angle;}if(this.y>sL-sH/2){this.y=sL-sH/2;this.angle=Math.PI-this.angle;}this.currentTailSway=Math.sin(time*this.tailFrequency+this.x*0.05)*this.tailAmplitude*(cS/1.5);}
            draw(){const{width,height}=this.scaledSize;ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);ctx.fillStyle=this.underbellyColor;ctx.beginPath();ctx.ellipse(0,height*0.1,width/2,height/2.2,0,0,Math.PI*2);ctx.fill();ctx.fillStyle=this.bodyColor;ctx.beginPath();ctx.ellipse(0,0,width/2,height/2,0,0,Math.PI*2);ctx.fill();ctx.fillStyle=this.finColor;ctx.beginPath();ctx.moveTo(width*0.1,-height*0.1);ctx.lineTo(width*0.05,-height*0.8);ctx.lineTo(-width*0.15,-height*0.05);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(width*0.2,height*0.2);ctx.lineTo(width*0.35,height*0.1+Math.sin(time*0.1)*2*(height/30));ctx.lineTo(width*0.3,height*0.4+Math.sin(time*0.1)*2*(height/30));ctx.closePath();ctx.fill();ctx.beginPath();const tBX=-width/2;ctx.moveTo(tBX,0);ctx.quadraticCurveTo(tBX-width*0.1,-height*0.1+this.currentTailSway,tBX-width*0.3,-height*0.6+this.currentTailSway*0.8);ctx.quadraticCurveTo(tBX-width*0.15,0+this.currentTailSway*0.5,tBX-width*0.3,height*0.6+this.currentTailSway*0.8);ctx.quadraticCurveTo(tBX-width*0.1,height*0.1+this.currentTailSway,tBX,0);ctx.closePath();ctx.fill();const eR=width*this.eyeSizeFactor;ctx.fillStyle='#111';ctx.beginPath();ctx.arc(width/2.8,-height*0.05,eR,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(200,200,200,0.3)';ctx.beginPath();ctx.arc(width/2.8+eR*0.2,-height*0.05-eR*0.2,eR*0.3,0,Math.PI*2);ctx.fill();ctx.restore();}
        }
        class Fish {
            constructor(isBig=false){this.isBig=isBig;const sM=isBig?random(1.8,2.5):random(0.8,1.5);this.baseSizeRef=canvas.height*0.02*sM;this.shapeTypes=['ellipse','tall','long','diamond'];this.shapeType=this.shapeTypes[randomInt(0,this.shapeTypes.length-1)];this.colorPatterns=['solid','stripes','spots'];this.colorPattern=this.colorPatterns[randomInt(0,this.colorPatterns.length-1)];this.bodyColor1=`hsl(${randomInt(0,360)},${randomInt(60,90)}%,${randomInt(40,70)}%)`;this.bodyColor2=`hsl(${randomInt(0,360)},${randomInt(60,90)}%,${randomInt(50,80)}%)`;this.finColor=`hsla(${randomInt(0,360)},70%,50%,0.7)`;this.eyeSizeFactor=random(0.08,0.15);this.x=random(0,canvas.width);const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;const tS=this._calculateScaledSize(this.baseSizeRef);this.y=random(sP+tS.height/2,sL-tS.height/2);this.targetX=this.x;this.targetY=this.y;this.speed=random(0.5,1.5)*(isBig?0.7:1);this.turnSpeed=random(0.02,0.05);this.angle=random(0,Math.PI*2);this.actionTimer=random(100,300);this.tailAmplitude=random(5,10);this.tailFrequency=random(0.2,0.4);this.currentTailSway=0;}
            _calculateScaledSize(baseSize){const sf=Math.min(canvas.width,canvas.height)/1000;let w=baseSize*sf;let h=baseSize*0.5*sf;if(this.shapeType==='tall'){h=baseSize*0.8*sf;w=baseSize*0.6*sf;}else if(this.shapeType==='long'){w=baseSize*1.5*sf;h=baseSize*0.4*sf;}else if(this.shapeType==='diamond'){w=baseSize*0.9*sf;h=baseSize*0.9*sf;}return{width:w,height:h};}
            get scaledSize(){return this._calculateScaledSize(this.baseSizeRef);}
            update(time){this.actionTimer--;const cS=this.speed*(canvas.width/1000);if(this.actionTimer<=0){const wR=100*(canvas.width/1000);this.targetX=this.x+random(-wR,wR);this.targetY=this.y+random(-wR,wR);const{width:fW,height:fH}=this.scaledSize;const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;this.targetX=Math.max(fW/2,Math.min(this.targetX,canvas.width-fW/2));this.targetY=Math.max(sP+fH/2,Math.min(this.targetY,sL-fH/2));this.actionTimer=random(100,300);}const dX=this.targetX-this.x;const dY=this.targetY-this.y;const tA=Math.atan2(dY,dX);let aD=tA-this.angle;while(aD>Math.PI)aD-=Math.PI*2;while(aD<-Math.PI)aD+=Math.PI*2;this.angle+=aD*this.turnSpeed;this.x+=Math.cos(this.angle)*cS;this.y+=Math.sin(this.angle)*cS;const{width:fW,height:fH}=this.scaledSize;if(this.x<-fW)this.x=canvas.width+fW;if(this.x>canvas.width+fW)this.x=-fW;const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;if(this.y<sP+fH/2){this.y=sP+fH/2;this.angle=Math.PI-this.angle;}if(this.y>sL-fH/2){this.y=sL-fH/2;this.angle=Math.PI-this.angle;}this.currentTailSway=Math.sin(time*this.tailFrequency+this.x*0.1)*this.tailAmplitude*(cS/1.0);}
            draw(){const{width,height}=this.scaledSize;ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);ctx.fillStyle=this.bodyColor1;ctx.beginPath();if(this.shapeType==='ellipse')ctx.ellipse(0,0,width/2,height/2,0,0,Math.PI*2);else if(this.shapeType==='tall')ctx.ellipse(0,0,width/2,height/2,0,0,Math.PI*2);else if(this.shapeType==='long')ctx.ellipse(0,0,width/2,height/2,0,0,Math.PI*2);else if(this.shapeType==='diamond'){ctx.moveTo(0,-height/2);ctx.lineTo(width/2,0);ctx.lineTo(0,height/2);ctx.lineTo(-width/2,0);ctx.closePath();}ctx.fill();if(this.colorPattern==='stripes'){ctx.fillStyle=this.bodyColor2;const sW=width/10;for(let i=-2;i<=2;i++)ctx.fillRect(-width/2+(i*2+2)*sW,-height/2,sW,height);}else if(this.colorPattern==='spots'){ctx.fillStyle=this.bodyColor2;const sR=width/15;for(let i=0;i<5;i++){ctx.beginPath();ctx.arc(random(-width/2.5,width/2.5),random(-height/3,height/3),sR*random(0.8,1.2),0,Math.PI*2);ctx.fill();}}ctx.fillStyle=this.finColor;ctx.beginPath();const tBX=-width/2;if(this.shapeType==='long'){ctx.moveTo(tBX,0);ctx.lineTo(tBX-width*0.3,-height/1.5+this.currentTailSway);ctx.lineTo(tBX-width*0.3,height/1.5+this.currentTailSway);}else{ctx.moveTo(tBX,0);ctx.lineTo(tBX-width*0.4,-height/2+this.currentTailSway);ctx.lineTo(tBX-width*0.4,height/2+this.currentTailSway);}ctx.closePath();ctx.fill();ctx.beginPath();if(this.shapeType==='tall'){ctx.moveTo(0,-height/2.2);ctx.lineTo(width*0.1,-height*0.8);ctx.lineTo(-width*0.1,-height*0.8);}else if(this.shapeType==='long'){ctx.moveTo(-width*0.2,-height/2);ctx.lineTo(width*0.3,-height/2);ctx.lineTo(width*0.1,-height*0.8);}else{ctx.moveTo(-width/6,-height/2.2);ctx.lineTo(width/6,-height/2.2);ctx.lineTo(0,-height*0.7);}ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(width*0.1,height*0.1);ctx.lineTo(width*0.3,height*0.05+Math.sin(time*0.2)*2*(height/20));ctx.lineTo(width*0.3,height*0.25+Math.sin(time*0.2)*2*(height/20));ctx.closePath();ctx.fill();const eR=width*this.eyeSizeFactor;ctx.fillStyle='white';ctx.beginPath();ctx.arc(width/3,0,eR,0,Math.PI*2);ctx.fill();ctx.fillStyle='black';ctx.beginPath();ctx.arc(width/3+eR*0.1,0,eR/2,0,Math.PI*2);ctx.fill();ctx.restore();}
        }
        class Seaweed{constructor(x,iH){this.x=x;this.baseY=canvas.height-(canvas.height*SEABED_OFFSET_FACTOR)+random(5,20);this.iHR=iH;this.amp=random(5,15);this.freq=random(0.01,0.03);this.phase=random(0,Math.PI*2);this.color=`rgba(0,${randomInt(80,120)},0,0.8)`;this.bLWR=random(3,8);this.cSway=0;}get height(){return this.iHR*(canvas.height/800);}get sAmp(){return this.amp*(canvas.height/800);}get lW(){return this.bLWR*(canvas.height/800);}update(t){this.cSway=Math.sin(t*this.freq+this.phase)*this.sAmp;}draw(){ctx.beginPath();ctx.moveTo(this.x,this.baseY);ctx.lineWidth=this.lW;ctx.strokeStyle=this.color;const seg=10;for(let i=1;i<=seg;i++){const y=this.baseY-(this.height/seg)*i;const xOff=Math.sin((i/seg)*Math.PI+time*this.freq*0.5+this.phase)*(this.sAmp*(i/seg));ctx.lineTo(this.x+this.cSway+xOff,y);}ctx.stroke();ctx.lineWidth=1;}}
        class Bubble{constructor(){this.bRRef=random(1,4);this.x=random(0,canvas.width);this.y=canvas.height-(canvas.height*(SEABED_OFFSET_FACTOR-0.02))+random(0,20);this.sY=random(0.5,1.5);this.sX=random(-0.2,0.2);this.op=random(0.3,0.8);}get radius(){return this.bRRef*(Math.min(canvas.width,canvas.height)/800);}update(){this.y-=this.sY;this.x+=this.sX;if(this.y<-this.radius*2){this.y=canvas.height-(canvas.height*(SEABED_OFFSET_FACTOR-0.02))+random(0,20);this.x=random(0,canvas.width);this.sY=random(0.5,1.5);this.op=random(0.3,0.8);}}draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.fillStyle=`rgba(200,225,255,${this.op})`;ctx.fill();ctx.strokeStyle=`rgba(220,240,255,${this.op*0.5})`;ctx.stroke();}}
        class Crab{constructor(){this.bSRef=random(canvas.height*0.03,canvas.height*0.05);this.x=random(0,canvas.width);this.y=canvas.height-(canvas.height*SEABED_OFFSET_FACTOR)+(this.bSRef*(Math.min(canvas.width,canvas.height)/800))/2+random(0,5);this.sX=random(0.2,0.5)*(Math.random()<0.5?1:-1);this.color=`hsl(${randomInt(0,30)},70%,50%)`;this.lPh=0;this.lSp=0.1;this.lAF=0.1;}get size(){return this.bSRef*(Math.min(canvas.width,canvas.height)/800);}get lAmp(){return this.size*this.lAF;}update(t){this.x+=this.sX*(canvas.width/1000);const cS=this.size;if(this.x-cS/2<0||this.x+cS/2>canvas.width){this.sX*=-1;this.x=Math.max(cS/2,Math.min(this.x,canvas.width-cS/2));}this.y=canvas.height-(canvas.height*SEABED_OFFSET_FACTOR)+cS/3;this.lPh=Math.sin(t*this.lSp)*this.lAmp;}draw(){const cS=this.size;ctx.save();ctx.translate(this.x,this.y);ctx.fillStyle=this.color;ctx.beginPath();ctx.ellipse(0,0,cS/1.5,cS/2,0,0,Math.PI*2);ctx.fill();const lW=cS*0.1;const lH=cS*0.3;ctx.fillStyle=`hsl(${randomInt(0,30)},70%,40%)`;for(let i=0;i<3;i++){const yOff=(i-1)*cS*0.15;const xOff=cS/2.5;const lSw=(i%2===0?this.lPh:-this.lPh);ctx.fillRect(xOff-lW/2,yOff-lH/2+lSw,lW,lH);ctx.fillRect(-xOff-lW/2,yOff-lH/2-lSw,lW,lH);}const pS=cS*0.25;ctx.fillStyle=`hsl(${randomInt(0,30)},80%,45%)`;ctx.beginPath();ctx.moveTo(cS/2,-cS*0.1);ctx.lineTo(cS/2+pS,-cS*0.1-pS/2+Math.sin(time*0.1)*2);ctx.lineTo(cS/2+pS,-cS*0.1+pS/2+Math.sin(time*0.1)*2);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(-cS/2,-cS*0.1);ctx.lineTo(-cS/2-pS,-cS*0.1-pS/2+Math.sin(time*0.1+0.5)*2);ctx.lineTo(-cS/2-pS,-cS*0.1+pS/2+Math.sin(time*0.1+0.5)*2);ctx.closePath();ctx.fill();ctx.fillStyle='black';ctx.beginPath();ctx.arc(cS*0.2,-cS*0.25,cS*0.05,0,Math.PI*2);ctx.arc(-cS*0.2,-cS*0.25,cS*0.05,0,Math.PI*2);ctx.fill();ctx.restore();}}
        class SchoolFish{constructor(sX,sY,sSRef){this.bSRef=sSRef*random(0.7,1.1);this.aOff=random(0,Math.PI*2);this.dFact=random(5,15);this.x=sX+Math.cos(this.aOff)*(sSRef*this.dFact);this.y=sY+Math.sin(this.aOff)*(sSRef*this.dFact);this.color=`hsl(${randomInt(180,240)},${randomInt(50,70)}%,${randomInt(60,80)}%)`;this.tSw=0;this.tSp=random(0.05,0.1);this.cA=random(0,Math.PI*2);}get size(){return this.bSRef*(Math.min(canvas.width,canvas.height)/1000);}get dist(){return this.bSRef*this.dFact*(Math.min(canvas.width,canvas.height)/1000);}update(sX,sY,sA,sSp,t){const tX=sX+Math.cos(this.aOff+sA)*this.dist;const tY=sY+Math.sin(this.aOff+sA)*this.dist;const dXTT=tX-this.x;const dYTT=tY-this.y;const tATT=Math.atan2(dYTT,dXTT);let aD=tATT-this.cA;while(aD>Math.PI)aD-=Math.PI*2;while(aD<-Math.PI)aD+=Math.PI*2;this.cA+=aD*this.tSp;const mSp=sSp*random(0.8,1.2);this.x+=Math.cos(this.cA)*mSp;this.y+=Math.sin(this.cA)*mSp;this.tSw=Math.sin(t*0.8+this.aOff)*this.size*0.5*(mSp/(0.5*canvas.width/1000));}draw(){const cS=this.size;ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.cA);ctx.fillStyle=this.color;ctx.beginPath();ctx.ellipse(0,0,cS,cS/2.5,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.moveTo(-cS,0);ctx.lineTo(-cS*1.5,-cS/4+this.tSw);ctx.lineTo(-cS*1.5,cS/4+this.tSw);ctx.closePath();ctx.fill();ctx.restore();}}
        class FishSchool{constructor(){this.fCnt=randomInt(12,25);this.fishes=[];this.bSFSRef=canvas.height*0.008;this.x=random(0,canvas.width);const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;this.y=random(sP+50,sL-80);this.tX=this.x;this.tY=this.y;this.angle=random(0,Math.PI*2);this.sBase=random(0.3,0.7);this.tSp=random(0.01,0.03);this.aTimer=random(150,350);for(let i=0;i<this.fCnt;i++)this.fishes.push(new SchoolFish(this.x,this.y,this.bSFSRef));}get speed(){return this.sBase*(canvas.width/1000);}update(t){this.aTimer--;if(this.aTimer<=0){const wR=150*(canvas.width/1000);this.tX=this.x+random(-wR,wR);this.tY=this.y+random(-wR,wR);const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;this.tX=Math.max(50,Math.min(this.tX,canvas.width-50));this.tY=Math.max(sP+50,Math.min(this.tY,sL-80));this.aTimer=random(150,350);}const dX=this.tX-this.x;const dY=this.tY-this.y;const tA=Math.atan2(dY,dX);let aD=tA-this.angle;while(aD>Math.PI)aD-=Math.PI*2;while(aD<-Math.PI)aD+=Math.PI*2;this.angle+=aD*this.tSp;this.x+=Math.cos(this.angle)*this.speed;this.y+=Math.sin(this.angle)*this.speed;if(this.x<-50)this.x=canvas.width+50;if(this.x>canvas.width+50)this.x=-50;const sL=canvas.height*(1-SEABED_OFFSET_FACTOR);const sP=canvas.height*0.1;if(this.y<sP+30){this.y=sP+30;this.angle+=Math.PI/2;}if(this.y>sL-60){this.y=sL-60;this.angle-=Math.PI/2;}this.fishes.forEach(f=>f.update(this.x,this.y,this.angle,this.speed,t));}draw(){this.fishes.forEach(f=>f.draw());}}

        function createShipwreck(){shipwreck=new Shipwreck(aquariumSettings.shipStyle);}
        function createCorals(){coralArray=[];const nC=Math.floor(canvas.width/120)+5;const sLY=canvas.height*(1-SEABED_OFFSET_FACTOR);for(let i=0;i<nC;i++){const x=random(canvas.width*0.05,canvas.width*0.95);const y=sLY+random(-10,20)*(canvas.height/800);const type=['brain','fan','tube'][randomInt(0,2)];if(!shipwreck||(x<shipwreck.x||x>shipwreck.x+shipwreck.baseWidth||y<shipwreck.y-20*(canvas.height/800))){coralArray.push(new Coral(x,y,type));}}coralArray.sort((a,b)=>a.y-b.y);}
        function createSeaweed(){seaweedArray=[];for(let i=0;i<aquariumSettings.numSeaweed;i++)seaweedArray.push(new Seaweed(random(0,canvas.width),random(canvas.height*0.1,canvas.height*0.3)));seaweedArray.sort((a,b)=>a.x-b.x);}
        function createPhytoplankton(){phytoplanktonArray=[];for(let i=0;i<aquariumSettings.numPhytoplankton;i++)phytoplanktonArray.push(new Phytoplankton());}
        function createIndependentFish(){fishArray=[];for(let i=0;i<aquariumSettings.numIndependentFish;i++)fishArray.push(new Fish(Math.random()<0.3));}
        function createSharks(){sharkArray=[];for(let i=0;i<aquariumSettings.numSharks;i++)sharkArray.push(new Shark());}
        function createBubbles(){bubbleArray=[];for(let i=0;i<aquariumSettings.numBubbles;i++)bubbleArray.push(new Bubble());}
        function createCrabs(){crabArray=[];const nCr=Math.floor(canvas.width/250)+1;for(let i=0;i<nCr;i++)crabArray.push(new Crab());}
        function createFishSchools(){fishSchoolArray=[];for(let i=0;i<aquariumSettings.numFishSchools;i++)fishSchoolArray.push(new FishSchool());}
        function createFoodParticles(x, y, count = 10) {
            for (let i = 0; i < count; i++) {
                foodParticlesArray.push(new FoodParticle(x + random(-10,10), y + random(-5,5)));
            }
        }

        function initAquarium() {
            console.log("Initializing aquarium elements...");
            fishArray=[];seaweedArray=[];coralArray=[];bubbleArray=[];crabArray=[];fishSchoolArray=[];sharkArray=[]; phytoplanktonArray=[]; foodParticlesArray=[];
            createShipwreck();createCorals();createSeaweed();createPhytoplankton();createIndependentFish();createSharks();createBubbles();createCrabs();createFishSchools();
            if(!soundSynth && typeof Tone!=='undefined'){try{soundSynth=new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:0.005,decay:0.1,sustain:0.05,release:0.1}}).toDestination();}catch(e){console.warn("Failed to init Tone.Synth:",e);soundSynth=null;}}
            console.log("Aquarium initialized with:", aquariumSettings);
            timeOfDayTimer = aquariumSettings.timeOfDayDuration * 60; // Convert seconds to frames (assuming 60fps target)
        }
        
        function playBubbleSound(note="C5"){if(aquariumSettings.playBubbleTouchSound&&soundSynth&&Date.now()-lastSoundTime>SOUND_COOLDOWN){try{soundSynth.triggerAttackRelease(note,"8n",Tone.now());lastSoundTime=Date.now();return true;}catch(e){console.warn("Tone.js sound error:",e);return false;}}return false;}
        function handleBubbleCollisions(){if(!aquariumSettings.playBubbleTouchSound||!soundSynth)return;bubbleArray.forEach(b=>{let sPFTB=false;for(const f of fishArray){if(checkCollision(b,f)){if(playBubbleSound("C5")){sPFTB=true;break;}}}if(!sPFTB){for(const s of sharkArray){if(checkCollision(b,s)){if(playBubbleSound("A4"))break;}}}});}
        function checkCollision(o1,o2){if(!o2.scaledSize||typeof o1.radius==='undefined')return false;const dist=Math.hypot(o1.x-o2.x,o1.y-o2.y);const cT=o1.radius+Math.max(o2.scaledSize.width,o2.scaledSize.height)/3;return dist<cT;}

        function cycleTimeOfDay() {
            const times = ['day', 'dusk', 'night', 'dawn'];
            let currentIndex = times.indexOf(aquariumSettings.currentTimeOfDay);
            currentIndex = (currentIndex + 1) % times.length;
            aquariumSettings.currentTimeOfDay = times[currentIndex];
            timeOfDayButton.textContent = `To ${times[(currentIndex + 1) % times.length].replace(/^\w/, c => c.toUpperCase())}`; // Update button text
            timeOfDayTimer = aquariumSettings.timeOfDayDuration * 60; // Reset timer
            console.log("Time of day changed to:", aquariumSettings.currentTimeOfDay);
        }

        function animate() {
            time += 0.1; 
            timeOfDayTimer--;
            if (aquariumSettings.timeOfDayDuration > 0 && timeOfDayTimer <= 0) {
                cycleTimeOfDay();
            }

            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            drawBackground();
            phytoplanktonArray.forEach(p => { p.update(); p.draw(); }); 
            if (shipwreck) shipwreck.draw();
            crabArray.forEach(c => { c.update(time); c.draw(); });
            coralArray.forEach(c => c.draw()); 
            seaweedArray.forEach(s => { s.update(time); s.draw(); });
            
            foodParticlesArray = foodParticlesArray.filter(fp => fp.opacity > 0); // Remove faded food
            foodParticlesArray.forEach(fp => { fp.update(); fp.draw(); });

            bubbleArray.forEach(b => { b.update(); b.draw(); });
            handleBubbleCollisions(); 
            fishArray.forEach(f => { f.update(time); f.draw(); });
            sharkArray.forEach(s => { s.update(time); s.draw(); });
            fishSchoolArray.forEach(fs => { fs.update(time); fs.draw(); });
            
            animationFrameId = requestAnimationFrame(animate); 
        }

        function updateSettingsFromUI(){
            aquariumSettings.numBubbles=parseInt(bubblesAmountSlider.value);
            aquariumSettings.numSeaweed=parseInt(seaweedAmountSlider.value);
            aquariumSettings.numPhytoplankton=parseInt(phytoplanktonAmountSlider.value); 
            aquariumSettings.numFishSchools=parseInt(fishSchoolsSlider.value);
            aquariumSettings.numIndependentFish=parseInt(independentFishSlider.value);
            aquariumSettings.numSharks=parseInt(sharksAmountSlider.value);
            aquariumSettings.shipStyle=shipStyleSelect.value;
            aquariumSettings.sandColor=sandColorSelect.value;
            aquariumSettings.timeOfDayDuration = parseInt(timeOfDayDurationSlider.value);
            aquariumSettings.playBubbleTouchSound=bubbleSoundCheckbox.checked;
        }
        function updateUIFromSettings(){
            bubblesAmountSlider.value=aquariumSettings.numBubbles;
            seaweedAmountSlider.value=aquariumSettings.numSeaweed;
            phytoplanktonAmountSlider.value=aquariumSettings.numPhytoplankton; 
            fishSchoolsSlider.value=aquariumSettings.numFishSchools;
            independentFishSlider.value=aquariumSettings.numIndependentFish;
            sharksAmountSlider.value=aquariumSettings.numSharks;
            shipStyleSelect.value=aquariumSettings.shipStyle;
            sandColorSelect.value=aquariumSettings.sandColor;
            timeOfDayDurationSlider.value = aquariumSettings.timeOfDayDuration;
            bubbleSoundCheckbox.checked=aquariumSettings.playBubbleTouchSound;

            bubblesAmountValueDisplay.textContent=aquariumSettings.numBubbles;
            seaweedAmountValueDisplay.textContent=aquariumSettings.numSeaweed;
            phytoplanktonAmountValueDisplay.textContent=aquariumSettings.numPhytoplankton; 
            fishSchoolsValueDisplay.textContent=aquariumSettings.numFishSchools;
            independentFishValueDisplay.textContent=aquariumSettings.numIndependentFish;
            sharksAmountValueDisplay.textContent=aquariumSettings.numSharks;
            timeOfDayDurationValueDisplay.textContent = aquariumSettings.timeOfDayDuration;
            timeOfDayButton.textContent = `To ${aquariumSettings.currentTimeOfDay === 'day' ? 'Dusk' : aquariumSettings.currentTimeOfDay === 'dusk' ? 'Night' : aquariumSettings.currentTimeOfDay === 'night' ? 'Dawn' : 'Day'}`;
        }
        
        function setupSettingsPanelListeners(){
            [bubblesAmountSlider,seaweedAmountSlider,phytoplanktonAmountSlider,fishSchoolsSlider,independentFishSlider,sharksAmountSlider, timeOfDayDurationSlider].forEach(slider=>{ 
                slider.addEventListener('input',(e)=>{
                    document.getElementById(e.target.id+'Value').textContent=e.target.value;
                });
            });
            settingsButton.addEventListener('click',()=>{if(typeof Tone!=='undefined'&&Tone.context.state!=='running'){Tone.start().catch(e=>console.warn("Tone.start() failed:",e));}updateUIFromSettings();settingsPanel.style.display='block';});
            applySettingsButton.addEventListener('click',()=>{updateSettingsFromUI();settingsPanel.style.display='none';if(animationFrameId)cancelAnimationFrame(animationFrameId);setupCanvasAndStart();});
            
            feedingButton.addEventListener('click', () => {
                createFoodParticles(random(canvas.width * 0.2, canvas.width * 0.8), canvas.height * 0.1, randomInt(15,25));
            });
            timeOfDayButton.addEventListener('click', cycleTimeOfDay);
        }

        function setupCanvasAndStart() {
            const margin = 20; const aspectRatio = 16 / 9;
            let newWidth = window.innerWidth - 2 * margin;
            let newHeight = window.innerHeight - 2 * margin;
            if (newWidth / newHeight > aspectRatio) newWidth = newHeight * aspectRatio;
            else newHeight = newWidth / aspectRatio;
            
            canvas.width = Math.max(100, newWidth); 
            canvas.height = Math.max(100, newHeight);
            console.log(`Canvas dimensions set to: ${canvas.width}x${canvas.height}`);

            initAquarium(); 
            if (animationFrameId) cancelAnimationFrame(animationFrameId); 
            animate();
        }
        
        window.addEventListener('resize', () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            setupCanvasAndStart();
        });

        console.log("Setting up initial UI and starting aquarium...");
        updateUIFromSettings(); 
        setupSettingsPanelListeners();
        setupCanvasAndStart();

    }); 
    </script>
</body>
</html>
