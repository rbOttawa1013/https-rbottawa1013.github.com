<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Diagram Editor</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for better readability -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Mermaid.js CDN for diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <style>
        /* Base styles for the light theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Lighter background */
            color: #1a202c; /* Default text color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1f2937; /* Dark background */
            color: #e2e8f0;
        }

        /* Main container for the app */
        .app-container {
            width: 100%;
            max-width: 1600px; /* Increased max width for more content */
            background-color: #ffffff;
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); /* Stronger shadow */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh; /* Take more vertical space */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .dark-mode .app-container {
            background-color: #2d3748;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 768px) {
            .app-container {
                flex-direction: row; /* Side-by-side on larger screens */
            }
            .editor-pane, .preview-pane {
                height: 100%; /* Take full height when side-by-side */
            }
        }

        .editor-pane, .preview-pane {
            flex: 1;
            padding: 2rem; /* Increased padding */
            display: flex;
            flex-direction: column;
        }

        .editor-pane {
            border-right: 1px solid #e2e8f0; /* Subtle separator */
            transition: border-color 0.3s ease;
        }

        .dark-mode .editor-pane {
            border-right: 1px solid #4a5568;
        }

        .preview-pane {
            overflow: auto;
            background-color: #f8fafc; /* Slightly different background for preview */
            position: relative;
            transition: background-color 0.3s ease;
        }

        .dark-mode .preview-pane {
            background-color: #27303f;
        }

        textarea {
            width: 100%;
            height: 100%;
            min-height: 250px; /* Slightly larger min-height */
            resize: none;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 1rem; /* Slightly larger font */
            line-height: 1.6;
            background-color: #f3f6f9; /* Lighter background for editor */
            border: 1px solid #cbd5e0;
            padding: 1.25rem; /* More padding */
            border-radius: 0.75rem; /* More rounded */
            transition: border-color 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            color: #2d3748; /* Text color for textarea */
        }
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Soft focus ring */
        }

        .dark-mode textarea {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .dark-mode textarea:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }

        /* Styling for Mermaid output */
        #diagram-preview svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .notification-message {
            padding: 0.75rem 1.25rem;
            border-radius: 0.625rem;
            margin-top: 1.5rem; /* Increased margin */
            font-size: 0.95rem;
            white-space: pre-wrap;
            overflow-x: auto;
            display: flex;
            align-items: center;
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .notification-message.error {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        .notification-message.success {
            background-color: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }
        .notification-message.info {
            background-color: #bfdbfe;
            color: #2563eb;
            border: 1px solid #93c5fd;
        }
        .notification-message.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .notification-icon {
            margin-right: 0.75rem; /* Increased margin */
            font-size: 1.5rem; /* Larger icon */
            line-height: 1;
        }

        /* Dark mode notifications */
        .dark-mode .notification-message.error {
            background-color: rgba(239, 68, 68, 0.2);
            border-color: rgba(252, 165, 165, 0.3);
            color: #fca5a5;
        }
        .dark-mode .notification-message.success {
            background-color: rgba(52, 211, 153, 0.2);
            border-color: rgba(110, 231, 183, 0.3);
            color: #6ee7b7;
        }
        .dark-mode .notification-message.info {
            background-color: rgba(99, 102, 241, 0.2);
            border-color: rgba(165, 180, 252, 0.3);
            color: #a5b4fc;
        }


        .button-group {
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Space between rows of buttons */
            margin-bottom: 2rem; /* More space below buttons */
        }

        @media (min-width: 768px) {
            .button-group {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: flex-start; /* Align groups to the start */
                align-items: center;
                gap: 1rem; /* Space between groups */
            }
            .button-group > div {
                display: flex;
                flex-wrap: wrap;
                gap: 0.75rem; /* Gap within each sub-group */
            }
        }


        .btn {
            padding: 0.85rem 1.5rem; /* Larger padding */
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap;
            border: 1px solid transparent;
            font-size: 0.95rem; /* Slightly larger font */
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15); /* Stronger shadow */
        }
        .btn-primary:hover {
            background-color: #4338ca;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px); /* More pronounced lift */
        }
        .btn-primary:active {
            background-color: #3730a3;
            box-shadow: none;
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: #eef2ff; /* Lighter indigo background */
            color: #4338ca;
            border: 1px solid #d4e0ff;
        }
        .btn-secondary:hover {
            background-color: #dbe4ff; /* Lighter indigo hover */
            color: #3730a3;
            transform: translateY(-2px);
        }
        .btn-secondary:active {
            background-color: #c0ccf7;
            transform: translateY(0);
        }

        /* Dark mode buttons */
        .dark-mode .btn-secondary {
            background-color: #3e4c62;
            color: #bfdbfe;
            border: 1px solid #5a6b8c;
        }
        .dark-mode .btn-secondary:hover {
            background-color: #4f5f7a;
            color: #e2e8f0;
        }


        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Slightly darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            padding: 2.5rem; /* More padding */
            border-radius: 1rem; /* More rounded */
            box-shadow: 0 12px 24px rgba(0,0,0,0.25); /* Stronger shadow */
            max-width: 1000px; /* Wider modal */
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-mode .modal-content {
            background-color: #2d3748;
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }

        .template-selector-group {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            margin-bottom: 2rem; /* More space */
            flex-wrap: wrap;
        }
        .template-selector {
            padding: 0.75rem 1.25rem; /* Larger padding */
            border-radius: 0.625rem; /* More rounded */
            border: 1px solid #cbd5e0;
            background-color: #f3f6f9;
            font-weight: 500;
            color: #2d3748;
            transition: all 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            min-width: 200px; /* Ensure consistent width */
        }
        .dark-mode .template-selector {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .template-selector:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .template-display {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 2rem; /* More padding */
            background-color: #f8fafc;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .dark-mode .template-display {
            background-color: #27303f;
            border-color: #4a5568;
        }

        .template-code {
            border-radius: 0.625rem;
            padding: 1.25rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.9rem; /* Slightly smaller for code clarity */
            overflow-x: auto;
            white-space: pre-wrap;
            background-color: #f3f6f9;
            color: #2d3748;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode .template-code {
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .template-description {
            color: #4a5568;
            margin-bottom: 1.25rem; /* More space */
            font-size: 1rem;
            line-height: 1.6;
        }
        .dark-mode .template-description {
            color: #a0aec0;
        }

        /* Loading state styles */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85); /* Slightly less opaque */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem; /* Larger font */
            color: #4f46e5;
            border-radius: 0.75rem;
            z-index: 10;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode .loading-overlay {
            background-color: rgba(30, 41, 59, 0.85); /* Darker overlay */
            color: #a5b4fc;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Editor Pane -->
        <section id="editorPane" class="editor-pane">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 dark:text-gray-100">Mermaid Notation Editor</h2>

            <div class="button-group">
                <!-- File Operations -->
                <div class="flex flex-wrap gap-3">
                    <button id="newBtn" class="btn btn-secondary">New</button>
                    <button id="importBtn" class="btn btn-secondary">Import .mmd</button>
                    <button id="saveMmdBtn" class="btn btn-primary">Save .mmd</button>
                    <button id="exportSvgBtn" class="btn btn-primary">Export as SVG</button>
                </div>

                <!-- Copy & View Toggles -->
                <div class="flex flex-wrap gap-3">
                    <button id="copyNotationBtn" class="btn btn-secondary">Copy Notation</button>
                    <button id="copySvgBtn" class="btn btn-secondary">Copy SVG</button>
                    <button id="fullscreenEditorBtn" class="btn btn-secondary">Fullscreen Editor</button>
                    <button id="fullscreenPreviewBtn" class="btn btn-secondary">Fullscreen Preview</button>
                </div>

                <!-- Appearance & Help -->
                <div class="flex flex-wrap gap-3">
                    <button id="helpBtn" class="btn btn-secondary">Help / Templates</button>
                    <div class="relative">
                        <select id="themeSelector" class="btn btn-secondary">
                            <option value="default">Theme: Default</option>
                            <option value="forest">Theme: Forest</option>
                            <option value="dark">Theme: Dark</option>
                            <option value="neutral">Theme: Neutral</option>
                            <option value="base">Theme: Base</option>
                        </select>
                    </div>
                    <button id="darkModeToggle" class="btn btn-secondary">Toggle Dark Mode</button>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".mmd,.txt" class="hidden">

            <textarea id="mermaidInput" placeholder="Start typing your Mermaid diagram notation here...">
graph TD
    A[Start] --> B(Process)
    B --> C{Decision}
    C -- Yes --> D[End Yes]
    C -- No --> E[End No]
            </textarea>

            <button id="backFromEditorFullscreen" class="btn btn-secondary mt-6 hidden self-center">Back to Main Screen</button>
        </section>

        <!-- Preview Pane -->
        <section id="previewPane" class="preview-pane">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 dark:text-gray-100">Diagram Preview</h2>
            <div id="diagram-preview" class="flex-grow flex items-center justify-center relative bg-white dark:bg-gray-800 rounded-lg p-4 shadow-inner">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-gray-400 text-xl dark:text-gray-500" id="emptyMessage">
                    Your diagram will appear here!
                </div>
                <div id="loadingIndicator" class="loading-overlay hidden">
                    <svg class="animate-spin h-8 w-8 text-indigo-600 dark:text-indigo-400 mr-3" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Rendering diagram...
                </div>
            </div>
            <div id="notificationDisplay" class="notification-message hidden">
                <span id="notificationIcon" class="notification-icon"></span>
                <span id="notificationText"></span>
            </div>

            <button id="backFromPreviewFullscreen" class="btn btn-secondary mt-6 hidden self-center">Back to Main Screen</button>
        </section>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 dark:text-gray-100">Mermaid Templates</h2>

            <div class="template-selector-group">
                <label for="templateSelector" class="font-medium text-gray-700 dark:text-gray-300 text-lg">Select Diagram Type:</label>
                <select id="templateSelector" class="template-selector">
                    <option value="flowchart">Flowchart</option>
                    <option value="sequence">Sequence Diagram</option>
                    <option value="class">Class Diagram</option>
                    <option value="state">State Diagram</option>
                    <option value="er">Entity Relationship Diagram</option>
                    <option value="gantt">Gantt Chart</option>
                    <option value="pie">Pie Chart</option>
                    <option value="requirement">Requirement Diagram</option>
                    <option value="git">Git Graph</option>
                    <option value="mindmap">Mind Map</option>
                    <option value="timeline">Timeline</option>
                    <option value="quadrant">Quadrant Chart</option>
                    <option value="user-journey">User Journey</option>
                    <option value="sankey">Sankey Diagram</option>
                    <option value="xychart">XY Chart</option>
                </select>
            </div>

            <div id="templateDisplay" class="template-display">
                <!-- Template content will be dynamically loaded here -->
            </div>

            <button id="backFromHelpBtn" class="btn btn-secondary mt-6 self-center">Back to Main Screen</button>
        </div>
    </div>

    <script>
        // DOM Element References
        const DOMElements = {
            body: document.body,
            appContainer: document.querySelector('.app-container'),
            editorPane: document.getElementById('editorPane'),
            previewPane: document.getElementById('previewPane'),
            mermaidInput: document.getElementById('mermaidInput'),
            diagramPreview: document.getElementById('diagram-preview'),
            notificationDisplay: document.getElementById('notificationDisplay'),
            notificationText: document.getElementById('notificationText'),
            notificationIcon: document.getElementById('notificationIcon'),
            emptyMessage: document.getElementById('emptyMessage'),
            loadingIndicator: document.getElementById('loadingIndicator'),

            newBtn: document.getElementById('newBtn'),
            importBtn: document.getElementById('importBtn'),
            fileInput: document.getElementById('fileInput'),
            saveMmdBtn: document.getElementById('saveMmdBtn'),
            exportSvgBtn: document.getElementById('exportSvgBtn'),
            helpBtn: document.getElementById('helpBtn'),
            themeSelector: document.getElementById('themeSelector'),

            copyNotationBtn: document.getElementById('copyNotationBtn'),
            copySvgBtn: document.getElementById('copySvgBtn'),
            fullscreenEditorBtn: document.getElementById('fullscreenEditorBtn'),
            fullscreenPreviewBtn: document.getElementById('fullscreenPreviewBtn'),
            darkModeToggle: document.getElementById('darkModeToggle'),

            helpModal: document.getElementById('helpModal'),
            templateSelector: document.getElementById('templateSelector'),
            templateDisplay: document.getElementById('templateDisplay'),

            backFromEditorFullscreenBtn: document.getElementById('backFromEditorFullscreen'),
            backFromPreviewFullscreenBtn: document.getElementById('backFromPreviewFullscreen'),
            backFromHelpBtn: document.getElementById('backFromHelpBtn'),
        };

        // Constants for Local Storage Keys
        const STORAGE_KEYS = {
            MERMAID_INPUT: 'mermaidInput',
            MERMAID_THEME: 'mermaidTheme',
            DARK_MODE: 'darkMode',
        };

        // Mermaid Templates and their descriptions
        const MERMAID_TEMPLATES = {
            flowchart: {
                syntax: `graph TD
    A[Christmas] -->|Get money| B(Go shopping)
    B --> C{Let me think}
    C -- One --> D[Laptop]
    C -- Two --> E[iPhone]
    C -- Three --> F[Car]`,
                description: `General-purpose diagrams (like org flows, processes). Syntax keyword: \`flowchart\` or \`graph\`.`
            },
            sequence: {
                syntax: `sequenceDiagram
    participant Alice
    participant Bob
    Alice->>John: Hello John, how are you?
    loop Healthcheck
        John->>John: Fight against hypochondria
    end
    alt is sick
        John-->>Alice: Not too good :(
    else is healthy
        John-->>Alice: Great!
    end
    Alice->>Bob: See you later!`,
                description: `Visualizes interactions in sequence (e.g., APIs, UX). Syntax keyword: \`sequenceDiagram\`.`
            },
            class: {
                syntax: `classDiagram
    class Animal{
        +String name
        +int age
        +void makeSound()
    }
    class Dog{
        +String breed
        +void bark()
    }
    class Cat{
        +String color
        +void meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat`,
                description: `UML-style class and object relationships. Syntax keyword: \`classDiagram\`.`
            },
            state: {
                syntax: `stateDiagram-v2
    [*] --> Still
    Still --> Moving: EvtMotion
    Moving --> Still: EvtStop
    Moving --> Crash : EvtCrash
    Crash --> [*]`,
                description: `Finite state machines / lifecycle diagrams. Syntax keyword: \`stateDiagram\` or \`stateDiagram-v2\`.`
            },
            er: {
                syntax: `erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    CUSTOMER }|--|{ DELIVERY_ADDRESS : uses`,
                description: `Database table and relationship structures. Syntax keyword: \`erDiagram\`.`
            },
            gantt: {
                syntax: `gantt
    dateFormat  YYYY-MM-DD
    title Adding GANTT diagram functionality to mermaid

    section A
    Task A           :a1, 2014-01-01, 30d
    Task B           :after a1  , 20d
    section B
    Task C           :2014-01-12  , 12d
    Task D           :2014-01-01  , 10d`,
                description: `Project timelines and scheduling. Syntax keyword: \`gantt\`.`
            },
            pie: {
                syntax: `pie title Daily Activities
    "Work" : 60
    "Eat" : 10
    "Commute" : 10
    "Relax" : 20`,
                description: `Shows proportions of data. Syntax keyword: \`pie\`.`
            },
            requirement: {
                syntax: `requirementDiagram

requirement test_req {
    id: 1
    text: the test text
    risk: high
    verifyMethod: test
}

element test_entity {
    type: functional
    docRef: gh/test_entity
    version: 0.1
}

test_entity - satisfies -> test_req`,
                description: `Visualize system/software requirements. Syntax keyword: \`requirementDiagram\`.`
            },
            git: {
                syntax: `gitGraph:
    commit
    commit
    branch develop
    checkout develop
    commit
    commit
    checkout main
    merge develop
    commit
    tag "v1.0"`,
                description: `Visualize git commits, branches, merges. Syntax keyword: \`gitGraph\`.`
            },
            mindmap: {
                syntax: `mindmap
  root((mindmap))
    Origins
      Long history
      ::icon(fa fa-book)
      ` + '`' + `Popularisation` + '`' + `
        ` + '`' + `British popular psychology author Tony Buzan` + '`' + `
    Uses
      ` + '`' + `Increase productivity` + '`' + `
      ` + '`' + `Effective note-taking` + '`' + `
    ` + '`' + `Advantages` + '`' + `
      ` + '`' + `Creativity` + '`' + `
      ` + '`' + `Efficiency` + '`' + `
      ` + '`' + `Visual appeal` + '`' + ``,
                description: `Hierarchical idea trees. Syntax keyword: \`mindmap\`. (Experimental)`
            },
            timeline: {
                syntax: `timeline
    title History of Internet
    section 1990s
        ` + '`' + `Tim Berners-Lee` + '`' + `: World Wide Web
        Netscape Navigator: "Browser Wars"
    section 2000s
        Dot-com bubble: burst
        Wikipedia: online encyclopedia
        Facebook: social media
    section 2010s
        Smartphones: mobile internet
        Cloud computing: rise of SaaS
        IoT: connected devices`,
                description: `Time-based events in vertical format. Syntax keyword: \`timeline\`.`
            },
            quadrant: {
                syntax: `quadrantChart
    title Reach and engagement of campaigns
    x-axis "Low Impact" --> "High Impact"
    y-axis "Low Reach" --> "High Reach"
    quadrant-1 We should expand
    quadrant-2 Also consider
    quadrant-3 Think more about
    quadrant-4 May be improved
    "Campaign A": [0.3, 0.6]
    "Campaign B": [0.45, 0.23]
    "Campaign C": [0.57, 0.65]
    "Campaign D": [0.78, 0.34]
    "Campaign E": [0.40, 0.34]
    "Campaign F": [0.35, 0.78]`,
                description: `Plot items on 2x2 grid (e.g. importance vs urgency). Syntax keyword: \`quadrantChart\`.`
            },
            'user-journey': {
                syntax: `journey
    title My working day
    section Go to work
      Make tea: 5: start, a
      Go upstairs: 3: a, b
      Do work: 10: b, c
    section Go home
      Go downstairs: 5: c, d
      Play with kids: 3: d, e
      Prepare dinner: 5: e, f`,
                description: `Customer/user journey maps. Syntax keyword: \`journey\`.`
            },
            sankey: {
                syntax: `sankey-beta
    Electricity -> Light: 50
    Electricity -> Heat: 30
    Electricity -> "Motor power": 20`,
                description: `Flow of resources or values. Syntax keyword: \`sankey\` or \`sankey-beta\`.`
            },
            xychart: {
                syntax: `xychart-beta
    title "Sales Performance"
    x-axis "Months"
    y-axis "Revenue (USD)"
    line "Product A"
        10, 20, 15, 25, 30
    line "Product B"
        5, 12, 8, 18, 22`,
                description: `Line and scatter charts. Syntax keyword: \`xychart\` or \`xychart-beta\`. (Experimental)`
            }
        };

        /**
         * Initializes Mermaid.js with the selected theme.
         * @param {string} themeName - The name of the Mermaid theme.
         */
        function initializeMermaid(themeName) {
            mermaid.initialize({
                startOnLoad: false,
                theme: themeName,
                securityLevel: 'loose'
            });
        }

        /**
         * Displays a notification message.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message.
         */
        function showNotification(message, type) {
            DOMElements.notificationText.textContent = message;
            DOMElements.notificationDisplay.className = `notification-message ${type}`; // Reset and apply type class

            let iconHtml = '';
            if (type === 'error') {
                iconHtml = '&#9888;'; // Warning sign
            } else if (type === 'success') {
                iconHtml = '&#10003;'; // Checkmark
            } else { // info
                iconHtml = '&#8505;'; // Info sign
            }
            DOMElements.notificationIcon.innerHTML = iconHtml;

            setTimeout(() => {
                DOMElements.notificationDisplay.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Renders the Mermaid diagram from the input text.
         * @param {string} graphDefinition - The Mermaid notation string.
         */
        async function renderDiagram(graphDefinition) {
            DOMElements.diagramPreview.innerHTML = ''; // Clear previous diagram
            DOMElements.notificationDisplay.classList.add('hidden'); // Hide any previous notifications
            DOMElements.emptyMessage.classList.add('hidden'); // Hide empty message
            DOMElements.loadingIndicator.classList.remove('hidden'); // Show loading indicator

            await new Promise(resolve => setTimeout(resolve, 10)); // Small delay for visual feedback

            if (!graphDefinition.trim()) {
                DOMElements.emptyMessage.classList.remove('hidden');
                DOMElements.loadingIndicator.classList.add('hidden');
                return;
            }

            try {
                const { svg, bindFunctions } = await mermaid.render('graphDiv', graphDefinition);
                DOMElements.diagramPreview.innerHTML = svg;
                if (bindFunctions) {
                    bindFunctions(DOMElements.diagramPreview);
                }
            } catch (error) {
                showNotification(`Mermaid Render Error:\n${error.message || error}`, 'error');
                console.error("Mermaid Render Error:", error);
            } finally {
                DOMElements.loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Resets the fullscreen state of both panes to the default split view.
         */
        function resetFullscreen() {
            DOMElements.editorPane.classList.remove('fullscreen');
            DOMElements.previewPane.classList.remove('fullscreen');
            DOMElements.editorPane.style.display = 'flex';
            DOMElements.previewPane.style.display = 'flex';

            DOMElements.fullscreenEditorBtn.textContent = 'Fullscreen Editor';
            DOMElements.fullscreenPreviewBtn.textContent = 'Fullscreen Preview';
            DOMElements.backFromEditorFullscreenBtn.classList.add('hidden');
            DOMElements.backFromPreviewFullscreenBtn.classList.add('hidden');

            renderDiagram(DOMElements.mermaidInput.value);
        }

        /**
         * Toggles fullscreen mode for a given pane.
         * @param {HTMLElement} targetPane - The pane to toggle fullscreen for.
         * @param {HTMLElement} otherPane - The other pane to hide/show.
         * @param {HTMLElement} toggleButton - The button that triggered the toggle.
         * @param {HTMLElement} backButton - The specific back button for this pane.
         * @param {string} originalButtonText - The original text for the toggle button.
         */
        function toggleFullscreenPane(targetPane, otherPane, toggleButton, backButton, originalButtonText) {
            const isCurrentlyInFullscreen = targetPane.classList.contains('fullscreen');

            // Always reset fullscreen state first
            resetFullscreen();

            // If the pane was NOT in fullscreen when the button was clicked, then enter fullscreen for it.
            if (!isCurrentlyInFullscreen) {
                targetPane.classList.add('fullscreen');
                otherPane.style.display = 'none';
                toggleButton.textContent = 'Exit Fullscreen';
                backButton.classList.remove('hidden');
            }
            renderDiagram(DOMElements.mermaidInput.value);
        }

        /**
         * Triggers a download for the given content as a file.
         * @param {string} content - The content to download.
         * @param {string} filename - The name of the file.
         * @param {string} mimeType - The MIME type of the file.
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Displays the selected template in the modal.
         * @param {string} templateKey - The key of the template to display.
         */
        function displaySelectedTemplate(templateKey) {
            const templateData = MERMAID_TEMPLATES[templateKey];
            if (templateData) {
                DOMElements.templateDisplay.innerHTML = `
                    <h3 class="text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-4">${templateKey.replace(/-/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')} Example</h3>
                    <p class="template-description">
                        ${templateData.description}
                    </p>
                    <pre class="template-code">${templateData.syntax}</pre>
                    <button class="btn btn-primary use-template-btn" data-template="${templateKey}">Use Template</button>
                `;
                DOMElements.templateDisplay.querySelector('.use-template-btn').addEventListener('click', (event) => {
                    const selectedTemplate = event.target.dataset.template;
                    DOMElements.mermaidInput.value = MERMAID_TEMPLATES[selectedTemplate].syntax;
                    renderDiagram(DOMElements.mermaidInput.value);
                    localStorage.setItem(STORAGE_KEYS.MERMAID_INPUT, DOMElements.mermaidInput.value);
                    DOMElements.helpModal.classList.add('hidden');
                    showNotification(`Template "${selectedTemplate}" loaded.`, 'success');
                });
            } else {
                DOMElements.templateDisplay.innerHTML = `<p class="text-gray-600 dark:text-gray-400">Template not found.</p>`;
            }
        }

        // --- Event Listeners ---

        DOMElements.mermaidInput.addEventListener('input', () => {
            renderDiagram(DOMElements.mermaidInput.value);
            localStorage.setItem(STORAGE_KEYS.MERMAID_INPUT, DOMElements.mermaidInput.value);
        });

        DOMElements.newBtn.addEventListener('click', () => {
            DOMElements.mermaidInput.value = '';
            renderDiagram('');
            localStorage.removeItem(STORAGE_KEYS.MERMAID_INPUT);
            showNotification('New diagram started.', 'info');
        });

        DOMElements.importBtn.addEventListener('click', () => {
            DOMElements.fileInput.click();
        });

        DOMElements.fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    DOMElements.mermaidInput.value = e.target.result;
                    renderDiagram(DOMElements.mermaidInput.value);
                    localStorage.setItem(STORAGE_KEYS.MERMAID_INPUT, DOMElements.mermaidInput.value);
                    showNotification(`File "${file.name}" imported.`, 'success');
                };
                reader.onerror = () => {
                    showNotification('Error reading file.', 'error');
                };
                reader.readAsText(file);
            }
            DOMElements.fileInput.value = '';
        });

        DOMElements.saveMmdBtn.addEventListener('click', () => {
            if (DOMElements.mermaidInput.value.trim()) {
                const filename = `mermaid-diagram-${Date.now()}.mmd`;
                downloadFile(DOMElements.mermaidInput.value, filename, 'text/plain');
                showNotification('Mermaid notation saved.', 'success');
            } else {
                showNotification('Nothing to save. Please type some Mermaid notation first.', 'error');
            }
        });

        DOMElements.exportSvgBtn.addEventListener('click', () => {
            const svgElement = DOMElements.diagramPreview.querySelector('svg');
            if (svgElement && DOMElements.mermaidInput.value.trim()) {
                const filename = `mermaid-diagram-${Date.now()}.svg`;
                const svgContent = new XMLSerializer().serializeToString(svgElement);
                downloadFile(svgContent, filename, 'image/svg+xml');
                showNotification('Diagram exported as SVG.', 'success');
            } else {
                showNotification('No diagram to export as SVG. Please draw a diagram first.', 'error');
            }
        });

        DOMElements.copyNotationBtn.addEventListener('click', () => {
            if (DOMElements.mermaidInput.value.trim()) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(DOMElements.mermaidInput.value)
                        .then(() => showNotification('Mermaid notation copied to clipboard!', 'success'))
                        .catch(err => showNotification('Error copying notation: ' + err.message, 'error'));
                } else {
                    DOMElements.mermaidInput.select();
                    try {
                        document.execCommand('copy');
                        showNotification('Mermaid notation copied to clipboard!', 'success');
                    } catch (err) {
                        showNotification('Failed to copy notation to clipboard. ' + err.message, 'error');
                    }
                    DOMElements.mermaidInput.blur();
                }
            } else {
                showNotification('Nothing to copy. Please type some Mermaid notation first.', 'error');
            }
        });

        DOMElements.copySvgBtn.addEventListener('click', () => {
            const svgElement = DOMElements.diagramPreview.querySelector('svg');
            if (svgElement && DOMElements.mermaidInput.value.trim()) {
                const svgContent = new XMLSerializer().serializeToString(svgElement);
                if (navigator.clipboard && navigator.clipboard.writeText) {
                     navigator.clipboard.writeText(svgContent)
                        .then(() => showNotification('SVG copied to clipboard!', 'success'))
                        .catch(err => showNotification('Error copying SVG: ' + err.message, 'error'));
                } else {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = svgContent;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    try {
                        document.execCommand('copy');
                        showNotification('SVG copied to clipboard!', 'success');
                    } catch (err) {
                        showNotification('Failed to copy SVG to clipboard. ' + err.message, 'error');
                    }
                    document.body.removeChild(tempTextArea);
                }
            } else {
                showNotification('No diagram to copy as SVG. Please draw a diagram first.', 'error');
            }
        });

        DOMElements.fullscreenEditorBtn.addEventListener('click', () => {
            toggleFullscreenPane(DOMElements.editorPane, DOMElements.previewPane, DOMElements.fullscreenEditorBtn, DOMElements.backFromEditorFullscreenBtn, 'Fullscreen Editor');
        });

        DOMElements.fullscreenPreviewBtn.addEventListener('click', () => {
            toggleFullscreenPane(DOMElements.previewPane, DOMElements.editorPane, DOMElements.fullscreenPreviewBtn, DOMElements.backFromPreviewFullscreenBtn, 'Fullscreen Preview');
        });

        DOMElements.backFromEditorFullscreenBtn.addEventListener('click', resetFullscreen);
        DOMElements.backFromPreviewFullscreenBtn.addEventListener('click', resetFullscreen);

        DOMElements.darkModeToggle.addEventListener('click', () => {
            DOMElements.body.classList.toggle('dark-mode');
            const isDarkMode = DOMElements.body.classList.contains('dark-mode');
            localStorage.setItem(STORAGE_KEYS.DARK_MODE, isDarkMode ? 'enabled' : 'disabled');
            renderDiagram(DOMElements.mermaidInput.value);
            showNotification(`Dark mode ${isDarkMode ? 'enabled' : 'disabled'}.`, 'info');
        });

        DOMElements.helpBtn.addEventListener('click', () => {
            DOMElements.helpModal.classList.remove('hidden');
            displaySelectedTemplate(DOMElements.templateSelector.value);
        });

        DOMElements.backFromHelpBtn.addEventListener('click', () => {
            DOMElements.helpModal.classList.add('hidden');
        });

        DOMElements.templateSelector.addEventListener('change', (event) => {
            displaySelectedTemplate(event.target.value);
        });

        DOMElements.themeSelector.addEventListener('change', (event) => {
            const selectedTheme = event.target.value;
            initializeMermaid(selectedTheme);
            renderDiagram(DOMElements.mermaidInput.value);
            localStorage.setItem(STORAGE_KEYS.MERMAID_THEME, selectedTheme);
            showNotification(`Mermaid theme changed to "${selectedTheme}".`, 'info');
        });

        // --- Initial Load Logic ---
        window.onload = () => {
            // Load dark mode preference
            const savedDarkMode = localStorage.getItem(STORAGE_KEYS.DARK_MODE);
            if (savedDarkMode === 'enabled') {
                DOMElements.body.classList.add('dark-mode');
            } else {
                DOMElements.body.classList.remove('dark-mode');
            }

            // Load input from local storage, or use default example
            const savedInput = localStorage.getItem(STORAGE_KEYS.MERMAID_INPUT);
            if (savedInput) {
                DOMElements.mermaidInput.value = savedInput;
            } else {
                DOMElements.mermaidInput.value = MERMAID_TEMPLATES.flowchart.syntax;
            }

            // Load Mermaid theme from local storage, or use 'default'
            const savedTheme = localStorage.getItem(STORAGE_KEYS.MERMAID_THEME);
            if (savedTheme) {
                DOMElements.themeSelector.value = savedTheme;
                initializeMermaid(savedTheme);
            } else {
                initializeMermaid('default');
            }

            renderDiagram(DOMElements.mermaidInput.value);
        };
    </script>
</body>
</html>

