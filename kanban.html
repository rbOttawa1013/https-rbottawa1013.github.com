
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoardMaster</title>
    <style>
        /* Global Resets and Base Styles */
        :root {
            --primary-bg: #f4f5f7;
            --secondary-bg: #ffffff;
            --tertiary-bg: #ebecf0;
            --text-color: #172b4d;
            --text-light: #5e6c84;
            --border-color: #dfe1e6;
            --accent-color: #0079bf;
            --accent-hover: #005c91;
            --danger-color: #de350b;
            --danger-hover: #bf2600;
            --success-color: #61bd4f; 
            --warning-color: #f2d600; 
            --filter-active-color: #4caf50; /* Color for active filter button */
            --card-bg: #ffffff;
            --list-bg: #ebecf0;
            --header-bg: #026aa7;
            --header-text: #ffffff;
            --modal-backdrop: rgba(0,0,0,0.5);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 3px;
            --shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --primary-bg: #0d1117;
            --secondary-bg: #161b22;
            --tertiary-bg: #21262d;
            --text-color: #c9d1d9;
            --text-light: #8b949e;
            --border-color: #30363d;
            --accent-color: #1f6feb;
            --accent-hover: #58a6ff;
            --danger-color: #f85149;
            --danger-hover: #da3633;
            --success-color: #238636;
            --warning-color: #e3b341;
            --filter-active-color: #2ea043;
            --card-bg: #161b22;
            --list-bg: #0d1117; 
            --header-bg: #161b22;
            --header-text: #c9d1d9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family); background-color: var(--primary-bg); color: var(--text-color);
            line-height: 1.5; display: flex; flex-direction: column; min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header */
        .app-header {
            background-color: var(--header-bg); color: var(--header-text); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); flex-wrap: wrap; 
        }
        .app-header h1 { font-size: 1.5em; margin-right: 15px; }
        .app-header-actions { display: flex; align-items: center; flex-wrap: wrap; }
        .app-header-actions button, .app-header-actions select {
            margin-left: 10px; margin-bottom: 5px; padding: 8px 12px; background-color: rgba(255,255,255,0.2);
            color: var(--header-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s;
        }
        .app-header-actions button:hover, .app-header-actions select:hover { background-color: rgba(255,255,255,0.3); }
        .app-header-actions select#boardSelector { min-width: 150px; }
        .app-header-actions button#filterCardsBtn.filter-active { background-color: var(--filter-active-color); color: white; }


        /* Main Content Area */
        .main-content { flex-grow: 1; padding: 20px; overflow-x: auto; }
        .view { display: none; } .view.active { display: block; }

        /* Board View (Kanban) */
        .board-view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .board-view-header h2 { font-size: 1.8em; color: var(--text-color); margin-right: 10px; margin-bottom: 10px; }
        .board-actions { display: flex; flex-wrap: wrap; }
        .board-actions button { margin-left: 10px; margin-bottom: 5px; }
        /* No need for specific #filterCardsBtn.filter-active here as it's in .app-header-actions */


        .lists-container { display: flex; gap: 10px; align-items: flex-start; overflow-x: auto; padding-bottom: 10px; min-height: calc(100vh - 250px); }
        .list {
            background-color: var(--list-bg); border-radius: var(--border-radius); padding: 10px; width: 280px; 
            flex-shrink: 0; box-shadow: var(--shadow); display: flex; flex-direction: column; max-height: calc(100vh - 280px); 
        }
        .list-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .list-header h3 { font-size: 1.1em; color: var(--text-color); cursor: pointer; flex-grow: 1; margin-right: 5px; word-break: break-all; }
        .list-actions { display:flex; position: relative; }
        .list-actions button { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 1em; padding: 5px; }
        .list-actions button:hover { color: var(--text-color); }
        .list-menu-btn { font-weight: bold; }
        .list-dropdown-menu {
            display: none; position: absolute; top: 100%; right: 0; background-color: var(--secondary-bg);
            border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            z-index: 10; min-width: 150px;
        }
        .list-dropdown-menu.active { display: block; }
        .list-dropdown-menu button { display: block; width: 100%; text-align: left; padding: 8px 12px; font-size: 0.9em; color: var(--text-color); }
        .list-dropdown-menu button:hover { background-color: var(--tertiary-bg); }

        .cards-container { flex-grow: 1; overflow-y: auto; min-height: 50px; padding: 5px; border-radius: var(--border-radius); }
        .cards-container::-webkit-scrollbar { width: 8px; }
        .cards-container::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; }
        .cards-container::-webkit-scrollbar-track { background-color: transparent; }

        .card {
            background-color: var(--card-bg); border-radius: var(--border-radius); padding: 10px; margin-bottom: 8px;
            box-shadow: var(--shadow); cursor: pointer; transition: box-shadow 0.2s; color: var(--text-color);
        }
        .card:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .card.dragging { opacity: 0.5; transform: rotate(3deg); }
        .card-title { font-weight: 500; margin-bottom: 5px; word-wrap: break-word; }
        .card-meta span { font-size: 0.8em; color: var(--text-light); margin-right: 8px; display: inline-flex; align-items: center; }
        .card-labels { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .card-label { padding: 2px 6px; border-radius: var(--border-radius); font-size: 0.75em; font-weight: bold; color: white; }

        /* Add List/Card Buttons & Forms */
        .add-item-btn { background-color: rgba(0,0,0,0.05); color: var(--text-light); border: none; border-radius: var(--border-radius); padding: 10px; width: 100%; text-align: left; cursor: pointer; transition: background-color 0.2s; margin-top: 10px; } 
        .add-item-btn:hover { background-color: rgba(0,0,0,0.1); color: var(--text-color); }
        .add-item-form { margin-top: 10px; padding: 5px; background-color: var(--tertiary-bg); border-radius: var(--border-radius); } 
        .add-item-form input, .add-item-form textarea { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--secondary-bg); color: var(--text-color); }
        .add-item-form-actions button { padding: 8px 12px; margin-right: 5px; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-backdrop); align-items: center; justify-content: center; } 
        .modal.active { display: flex; }
        .modal-content { background-color: var(--secondary-bg); color: var(--text-color); margin: auto; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 90%; max-width: 600px; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-content.modal-lg { max-width: 800px; } .modal-content.modal-xl { max-width: 950px; } .modal-content.modal-sm { max-width: 450px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; } 
        .modal-header h3 { font-size: 1.3em; } 
        .close-btn { color: var(--text-light); font-size: 1.5em; font-weight: bold; cursor: pointer; background: none; border: none; } 
        .close-btn:hover { color: var(--text-color); }
        .modal-body { overflow-y: auto; flex-grow: 1; } .modal-body .form-group { margin-bottom: 15px; } .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-light); }
        .modal-body input, .modal-body textarea, .modal-body select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--primary-bg); color: var(--text-color); }
        .modal-body textarea { min-height: 100px; resize: vertical; }
        .modal-footer { padding-top: 15px; margin-top: 20px; border-top: 1px solid var(--border-color); text-align: right; flex-shrink: 0; } 
        .modal-footer button { padding: 10px 15px; margin-left: 10px; }

        /* Buttons */
        .btn { padding: 10px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; transition: background-color 0.2s, opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; } 
        .btn-sm { padding: 5px 10px; font-size: 0.9em; } 
        .btn-primary { background-color: var(--accent-color); color: white; } .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: var(--tertiary-bg); color: var(--text-color); border: 1px solid var(--border-color); } .btn-secondary:hover { background-color: var(--border-color); } 
        .btn-danger { background-color: var(--danger-color); color: white; } .btn-danger:hover { background-color: var(--danger-hover); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Welcome Screen */ .welcome-screen { text-align: center; padding: 50px 20px; } .welcome-screen h2 { font-size: 2em; margin-bottom: 20px; } .welcome-screen p { font-size: 1.2em; color: var(--text-light); margin-bottom: 30px; }

        /* Card Details Modal Specifics */
        #cardDetailsModal .modal-content { max-width: 800px; } .card-details-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .card-main-content .form-group, .card-sidebar .form-group { margin-bottom: 15px; }
        .card-sidebar h4, .card-main-content h4 { font-size: 1em; color: var(--text-light); margin-top: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .checklist-group { padding: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 10px; background-color: var(--primary-bg); } 
        .checklist-item { display: flex; align-items: center; margin-bottom: 5px; padding: 3px; border-radius: var(--border-radius); } .checklist-item:hover { background-color: var(--tertiary-bg); }
        .checklist-item input[type="checkbox"] { width: auto; margin-right: 8px; flex-shrink: 0; } .checklist-item input[type="text"] { flex-grow: 1; border: none; padding: 5px; background-color: transparent; }
        .checklist-item input[type="text"]:focus { background-color: var(--secondary-bg); outline: 1px solid var(--accent-color); } .checklist-item .delete-checklist-item-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; margin-left: 5px; padding: 3px; }
        #cardLabelsContainer span, #cardAssignedUserContainer span { display: inline-block; padding: 3px 8px; border-radius: var(--border-radius); margin-right: 5px; margin-bottom: 5px; font-size: 0.9em; }
        #cardCommentsContainer .comment { background-color: var(--tertiary-bg); padding: 8px; border-radius: var(--border-radius); margin-bottom: 8px; font-size: 0.9em; } #cardCommentsContainer .comment-meta { font-size: 0.8em; color: var(--text-light); margin-bottom: 3px; }
        #cardAttachmentsContainer .attachment-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background-color: var(--tertiary-bg); border-radius: var(--border-radius); margin-bottom: 5px; word-break: break-all; }
        .attachment-item a { color: var(--accent-color); text-decoration: none; } .attachment-item a:hover { text-decoration: underline; }
        .attachment-item img.attachment-preview { max-width: 40px; max-height: 40px; margin-right: 10px; border-radius: var(--border-radius); }

        /* Custom Fields */ .custom-field-item { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; } .custom-field-item label { margin-bottom: 0; width: 120px; white-space: nowrap; font-size: 0.9em; } .custom-field-item input, .custom-field-item select { flex-grow: 1; }

        /* Analytics, Calendar, Table Views */ /* ... (largely same) ... */
        #analyticsViewContainer .chart-container { /* ... */ } #analyticsViewContainer .chart-container h3 { /* ... */ } .bar-chart { /* ... */ } .bar-chart .bar { /* ... */ } .bar-chart .bar .bar-value { /* ... */ } .bar-chart .bar .bar-label { /* ... */ }
        #calendarViewContainer { /* ... */ } .calendar-header { /* ... */ } .calendar-grid { /* ... */ } .calendar-day-header, .calendar-day { /* ... */ } .calendar-day-header { /* ... */ } .calendar-day .date-number { /* ... */ } .calendar-day.today .date-number { /* ... */ } .calendar-card-item { /* ... */ } .calendar-card-item:hover { /* ... */ }
        #tableViewContainer table { /* ... */ } #tableViewContainer th, #tableViewContainer td { /* ... */ } #tableViewContainer th { /* ... */ } #tableViewContainer th:hover { /* ... */ }


        /* Message Modal */ #messageModal .modal-body { text-align: center; font-size: 1.1em; padding: 20px; } #messageModal .modal-footer { justify-content: center; text-align: center; }

        /* Archived Cards & Activity Log Modal */
        .archived-card-item, .activity-log-item { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .archived-card-item:last-child, .activity-log-item:last-child { border-bottom: none; }
        .archived-card-info, .activity-log-info { flex-grow: 1; word-break: break-word; }
        .activity-log-item .timestamp { font-size: 0.8em; color: var(--text-light); margin-left: 10px; white-space: nowrap; }

        /* Filter Modal Specifics */
        #filterModal .filter-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        #filterModal .filter-section:last-child { border-bottom: none; margin-bottom: 0; }
        #filterModal .filter-section h4 { font-size: 1.1em; margin-bottom: 10px; color: var(--text-light); }
        #filterModal .filter-options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
        #filterModal .filter-options-grid label { display: flex; align-items: center; font-weight: normal; font-size: 0.9em; cursor: pointer; }
        #filterModal .filter-options-grid input[type="checkbox"] { margin-right: 8px; width: auto; cursor: pointer; }
        #filterModal .filter-options-grid .label-color-swatch { width: 12px; height: 12px; border-radius: 2px; margin-right: 6px; display: inline-block; border: 1px solid var(--border-color); }

        /* Utility Classes */ .hidden { display: none !important; } .text-center { text-align: center; } .mt-1 { margin-top: 0.5rem; } .mb-1 { margin-bottom: 0.5rem; } .p-1 { padding: 0.5rem; }
        /* Responsive adjustments */ /* ... (same or minor tweaks if needed) ... */
        @media (max-width: 768px) { /* ... */ } @media (max-width: 480px) { /* ... */ }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>BoardMaster</h1>
        <div class="app-header-actions">
            <select id="boardSelector" title="Select Board"></select>
            <button id="newBoardBtn" title="Create New Board">New Board</button>
            <button id="filterCardsBtn" title="Filter Cards" disabled>🔍 Filter</button>
            <button id="boardActivityLogBtn" title="View Board Activity" disabled>📜 Activity</button>
            <button id="settingsBtn" title="App Settings">⚙️ Settings</button>
            <select id="themeSelector" title="Change Theme"><option value="light">Light</option><option value="dark">Dark</option></select>
        </div>
    </header>

    <main class="main-content">
        <div id="kanbanView" class="view active">
            <div class="board-view-header">
                <h2 id="currentBoardTitle">No Board Selected</h2>
                <div class="board-actions">
                    <button id="addListBtn" class="btn btn-secondary" disabled>+ Add List</button>
                    <button id="viewCalendarBtn" class="btn btn-secondary" disabled>📅 Calendar</button>
                    <button id="viewTableBtn" class="btn btn-secondary" disabled>📋 Table</button>
                    <button id="viewAnalyticsBtn" class="btn btn-secondary" disabled>📊 Analytics</button>
                </div>
            </div>
            <div id="listsContainer" class="lists-container"></div>
        </div>
        <div id="calendarView" class="view"> <div class="board-view-header"><h2 id="calendarBoardTitle">Calendar View</h2><button id="backToKanbanFromCalendarBtn" class="btn btn-secondary">Back to Board</button></div> <div id="calendarViewContainer"><div class="calendar-header"><button id="prevMonthBtn" class="btn btn-secondary">&lt; Prev</button><h3 id="currentMonthYear">Month Year</h3><button id="nextMonthBtn" class="btn btn-secondary">Next &gt;</button></div><div class="calendar-grid" id="calendarGrid"></div></div> </div>
        <div id="tableView" class="view">  <div class="board-view-header"><h2 id="tableBoardTitle">Table View</h2><button id="backToKanbanFromTableBtn" class="btn btn-secondary">Back to Board</button></div> <div id="tableViewContainer"><table><thead><tr id="tableHeaderRow"></tr></thead><tbody id="tableBody"></tbody></table></div> </div>
        <div id="analyticsView" class="view"> <div class="board-view-header"><h2 id="analyticsBoardTitle">Analytics View</h2><button id="backToKanbanFromAnalyticsBtn" class="btn btn-secondary">Back to Board</button></div> <div id="analyticsViewContainer"><div class="chart-container"><h3>Tasks per List</h3><div id="tasksPerListChart" class="bar-chart"></div></div><div class="chart-container"><h3>Task Completion Rate (Placeholder)</h3><p>Analytics for task completion rates and overdue tasks will be implemented in a future update.</p></div></div> </div>
        <div id="welcomeScreen" class="welcome-screen hidden"><h2>Welcome to BoardMaster!</h2><p>Create your first board to get started, or import existing data from Settings.</p><button id="welcomeNewBoardBtn" class="btn btn-primary">Create New Board</button></div>
    </main>

    <div id="boardModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="boardModalTitle">Create New Board</h3><button class="close-btn" data-modal-id="boardModal">&times;</button></div><div class="modal-body"><input type="hidden" id="boardModalId"><div class="form-group"><label for="boardName">Board Name:</label><input type="text" id="boardName" required></div><div class="form-group"><label for="boardDescription">Description (Optional):</label><textarea id="boardDescription"></textarea></div><div class="form-group"><label for="boardBgColor">Background Color:</label><input type="color" id="boardBgColor" value="#0079bf"></div></div><div class="modal-footer"><button id="saveBoardBtn" class="btn btn-primary">Save Board</button><button class="btn btn-secondary close-btn" data-modal-id="boardModal">Cancel</button></div></div></div>
    <div id="listModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="listModalTitle">Create New List</h3><button class="close-btn" data-modal-id="listModal">&times;</button></div><div class="modal-body"><input type="hidden" id="listModalId"><input type="hidden" id="listModalBoardId"><div class="form-group"><label for="listName">List Name:</label><input type="text" id="listName" required></div></div><div class="modal-footer"><button id="saveListBtn" class="btn btn-primary">Save List</button><button class="btn btn-secondary close-btn" data-modal-id="listModal">Cancel</button></div></div></div>
    <div id="bulkAddCardsModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="bulkAddCardsModalTitle">Bulk Add Cards to List</h3><button class="close-btn" data-modal-id="bulkAddCardsModal">&times;</button></div><div class="modal-body"><input type="hidden" id="bulkAddCardsListId"><div class="form-group"><label for="bulkCardTitles">Card Titles (one per line):</label><textarea id="bulkCardTitles" rows="10"></textarea></div></div><div class="modal-footer"><button id="saveBulkAddCardsBtn" class="btn btn-primary">Add Cards</button><button class="btn btn-secondary close-btn" data-modal-id="bulkAddCardsModal">Cancel</button></div></div></div>
    <div id="cardDetailsModal" class="modal"><div class="modal-content modal-lg"><div class="modal-header"><h3 id="cardModalTitle">Card Details</h3><button class="close-btn" data-modal-id="cardDetailsModal">&times;</button></div><div class="modal-body"><input type="hidden" id="cardModalId"><input type="hidden" id="cardModalListId"><input type="hidden" id="cardModalBoardId"><div class="card-details-grid"><div class="card-main-content"><div class="form-group"><label for="cardTitle">Title:</label><input type="text" id="cardTitle" required></div><div class="form-group"><label for="cardDescription">Description (Markdown: **bold**, *italic*, [link](url)):</label><textarea id="cardDescription"></textarea><div id="cardDescriptionPreview" class="p-1 mt-1" style="border: 1px solid var(--border-color); min-height: 50px; background-color: var(--tertiary-bg); border-radius: var(--border-radius);"></div></div><div class="form-group"><h4>Checklists</h4><div id="cardChecklistsContainer"></div><button id="addChecklistBtn" class="btn btn-secondary btn-sm mt-1">+ Add Checklist</button></div><div class="form-group"><h4>Attachments (Max 1MB per file)</h4><input type="file" id="cardAttachmentInput" multiple><small>Note: Large attachments can impact performance and storage.</small><div id="cardAttachmentsContainer" class="mt-1"></div></div><div class="form-group"><h4>Comments</h4><div id="cardCommentsContainer" class="mt-1" style="max-height: 200px; overflow-y: auto;"></div><textarea id="newCommentText" placeholder="Add a comment..." rows="3"></textarea><button id="addCommentBtn" class="btn btn-secondary btn-sm mt-1">Add Comment</button></div></div><div class="card-sidebar"><div class="form-group"><label for="cardDueDate">Due Date:</label><input type="date" id="cardDueDate"><input type="time" id="cardDueTime" class="mt-1"></div><div class="form-group"><label for="cardLabels">Labels (comma-separated):</label><input type="text" id="cardLabelsInput" placeholder="e.g., Urgent,Bug"><div id="cardLabelsContainer" class="mt-1"></div><small>Colors: red, green, blue, yellow, orange, purple, black, pink, sky, lime</small></div><div class="form-group"><label for="cardPriority">Priority:</label><select id="cardPriority"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div><div class="form-group"><label for="cardAssignedUser">Assign to (Simulated User, comma-separated):</label><input type="text" id="cardAssignedUserInput" placeholder="e.g., Admin, Member1"><div id="cardAssignedUserContainer" class="mt-1"></div></div><div class="form-group"><h4>Time Tracking</h4><button id="timeTrackerBtn" class="btn btn-secondary btn-sm">Start Timer</button><p id="timeTrackedDisplay" class="mt-1">Total: 0s</p></div><div class="form-group"><h4>Custom Fields (Board Specific)</h4><div id="cardCustomFieldsContainer"></div></div><div class="form-group"><h4>Card Actions</h4><button id="archiveCardBtn" class="btn btn-secondary btn-sm">📦 Archive Card</button><button id="deleteCardBtn" class="btn btn-danger btn-sm mt-1">🗑️ Delete Card</button></div></div></div></div><div class="modal-footer"><button id="saveCardBtn" class="btn btn-primary">Save Card</button><button class="btn btn-secondary close-btn" data-modal-id="cardDetailsModal">Cancel</button></div></div></div>
    <div id="settingsModal" class="modal"><div class="modal-content modal-lg"><div class="modal-header"><h3>Application Settings</h3><button class="close-btn" data-modal-id="settingsModal">&times;</button></div><div class="modal-body"><div class="form-group"><label for="notificationsToggleBtn">Desktop Notifications for Due Dates:</label><button id="notificationsToggleBtn" class="btn btn-secondary">Enable Notifications</button></div><hr style="margin: 20px 0;"><h4>Board Management</h4><div class="form-group"><label for="boardExportBtn">Export Current Board Data (JSON):</label><button id="boardExportBtn" class="btn btn-secondary">Export Board</button></div><div class="form-group"><label for="boardImportInput">Import Board Data (JSON):</label><input type="file" id="boardImportInput" accept=".json"><button id="boardImportBtn" class="btn btn-secondary mt-1">Import Selected Board File</button></div><div class="form-group"><label for="exportAllBoardsBtn">Export All Boards Data (JSON):</label><button id="exportAllBoardsBtn" class="btn btn-secondary">Export All Boards</button></div><div class="form-group"><label for="importAllBoardsInput">Import All Boards Data (JSON):</label><input type="file" id="importAllBoardsInput" accept=".json"><button id="importAllBoardsBtn" class="btn btn-secondary mt-1">Import All Boards File</button></div><hr style="margin: 20px 0;"><h4>Archived Cards</h4><div class="form-group"><label>View/Restore Archived Cards for Current Board:</label><button id="viewArchivedCardsBtn" class="btn btn-secondary" disabled>View Archived</button></div><hr style="margin: 20px 0;"><h4>Automation Rules (Placeholder)</h4><p>Define rules like "When a card is moved to 'Done', mark due date as complete."</p><p><em>Full implementation of complex automation is planned for future updates.</em></p><hr style="margin: 20px 0;"><h4>Simulated Users & Custom Fields (Placeholder)</h4><p>Manage a list of simulated user profiles and define custom field types for boards.</p><p><em>Currently, assignees are simple text fields. Custom fields are defined per board (not yet editable via UI here).</em></p><hr style="margin: 20px 0;"><h4>Storage Information</h4><p id="localStorageUsage">Calculating storage usage...</p><p><small>LocalStorage limit is typically 5-10MB. Be mindful of large attachments as they are stored as Base64 text.</small></p><button id="clearAllDataBtn" class="btn btn-danger mt-1">Clear All Local Data (Warning!)</button></div><div class="modal-footer"><button class="btn btn-primary close-btn" data-modal-id="settingsModal">Close Settings</button></div></div></div>
    <div id="archivedCardsModal" class="modal"><div class="modal-content modal-xl"><div class="modal-header"><h3 id="archivedCardsModalTitle">Archived Cards</h3><button class="close-btn" data-modal-id="archivedCardsModal">&times;</button></div><div class="modal-body" id="archivedCardsListContainer" style="max-height: 70vh; overflow-y: auto;"><p>No archived cards for this board.</p></div><div class="modal-footer"><button class="btn btn-secondary close-btn" data-modal-id="archivedCardsModal">Close</button></div></div></div>
    <div id="activityLogModal" class="modal"><div class="modal-content modal-xl"><div class="modal-header"><h3 id="activityLogModalTitle">Board Activity Log</h3><button class="close-btn" data-modal-id="activityLogModal">&times;</button></div><div class="modal-body" id="activityLogContainer" style="max-height: 70vh; overflow-y: auto;"><p>No activity recorded for this board yet.</p></div><div class="modal-footer"><button class="btn btn-secondary close-btn" data-modal-id="activityLogModal">Close</button></div></div></div>
    <div id="confirmationModal" class="modal"><div class="modal-content modal-sm"><div class="modal-header"><h3 id="confirmationModalTitle">Confirm Action</h3><button class="close-btn" data-modal-id="confirmationModal">&times;</button></div><div class="modal-body"><p id="confirmationModalMessage">Are you sure?</p></div><div class="modal-footer"><button id="confirmActionBtn" class="btn btn-danger">Confirm</button><button id="cancelActionBtn" class="btn btn-secondary close-btn" data-modal-id="confirmationModal">Cancel</button></div></div></div>
    <div id="messageModal" class="modal"><div class="modal-content modal-sm"><div class="modal-header"><h3 id="messageModalTitle">Notification</h3><button class="close-btn" data-modal-id="messageModal">&times;</button></div><div class="modal-body"><p id="messageModalText">Message goes here.</p></div><div class="modal-footer"><button class="btn btn-primary close-btn" data-modal-id="messageModal">OK</button></div></div></div>
    
    <div id="filterModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header"><h3>Filter Cards</h3><button class="close-btn" data-modal-id="filterModal">&times;</button></div>
            <div class="modal-body">
                <div class="filter-section"><h4>Search by Keyword</h4><input type="text" id="filterText" placeholder="Search card titles and descriptions..."></div>
                <div class="filter-section"><h4>Filter by Labels</h4><div id="filterLabelsContainer" class="filter-options-grid"><p><small>No labels found on this board.</small></p></div></div>
                <div class="filter-section"><h4>Filter by Assignees</h4><div id="filterAssigneesContainer" class="filter-options-grid"><p><small>No assignees found on this board.</small></p></div></div>
                <div class="filter-section"><h4>Filter by Due Date</h4><select id="filterDueDateSelect"><option value="any">Any Date</option><option value="noDate">No Due Date</option><option value="overdue">Overdue</option><option value="dueToday">Due Today</option><option value="dueTomorrow">Due Tomorrow</option><option value="dueNext7Days">Due in Next 7 Days</option></select></div>
            </div>
            <div class="modal-footer"><button id="applyFiltersBtn" class="btn btn-primary">Apply Filters</button><button id="clearFiltersBtn" class="btn btn-secondary">Clear Filters</button><button class="btn btn-secondary close-btn" data-modal-id="filterModal">Cancel</button></div>
        </div>
    </div>

    <script>
        // --- APPLICATION SCOPE ---
        (function() {
            'use strict';

            // --- DOM Elements ---
            const filterCardsBtn = document.getElementById('filterCardsBtn');
            const filterModal = document.getElementById('filterModal');
            const filterText = document.getElementById('filterText');
            const filterLabelsContainer = document.getElementById('filterLabelsContainer');
            const filterAssigneesContainer = document.getElementById('filterAssigneesContainer');
            const filterDueDateSelect = document.getElementById('filterDueDateSelect');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            // ... (all other existing DOM element declarations) ...
            const themeSelector = document.getElementById('themeSelector');
            const newBoardBtn = document.getElementById('newBoardBtn');
            const boardSelector = document.getElementById('boardSelector');
            const settingsBtn = document.getElementById('settingsBtn');
            const boardActivityLogBtn = document.getElementById('boardActivityLogBtn');
            const notificationsToggleBtn = document.getElementById('notificationsToggleBtn');
            const currentBoardTitleEl = document.getElementById('currentBoardTitle');
            const listsContainer = document.getElementById('listsContainer');
            const addListBtn = document.getElementById('addListBtn');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const welcomeNewBoardBtn = document.getElementById('welcomeNewBoardBtn');
            const views = { kanban: document.getElementById('kanbanView'), calendar: document.getElementById('calendarView'), table: document.getElementById('tableView'), analytics: document.getElementById('analyticsView') };
            const viewCalendarBtn = document.getElementById('viewCalendarBtn');
            const viewTableBtn = document.getElementById('viewTableBtn');
            const viewAnalyticsBtn = document.getElementById('viewAnalyticsBtn');
            const backToKanbanFromCalendarBtn = document.getElementById('backToKanbanFromCalendarBtn');
            const backToKanbanFromTableBtn = document.getElementById('backToKanbanFromTableBtn');
            const backToKanbanFromAnalyticsBtn = document.getElementById('backToKanbanFromAnalyticsBtn');
            const calendarBoardTitle = document.getElementById('calendarBoardTitle');
            const tableBoardTitle = document.getElementById('tableBoardTitle');
            const analyticsBoardTitle = document.getElementById('analyticsBoardTitle');
            const boardModal = document.getElementById('boardModal');
            const boardModalTitle = document.getElementById('boardModalTitle');
            const boardModalIdInput = document.getElementById('boardModalId');
            const boardNameInput = document.getElementById('boardName');
            const boardDescriptionInput = document.getElementById('boardDescription');
            const boardBgColorInput = document.getElementById('boardBgColor');
            const saveBoardBtn = document.getElementById('saveBoardBtn');
            const listModal = document.getElementById('listModal');
            const listModalTitle = document.getElementById('listModalTitle');
            const listModalIdInput = document.getElementById('listModalId');
            const listModalBoardIdInput = document.getElementById('listModalBoardId');
            const listNameInput = document.getElementById('listName');
            const saveListBtn = document.getElementById('saveListBtn');
            const bulkAddCardsModal = document.getElementById('bulkAddCardsModal');
            const bulkAddCardsModalTitle = document.getElementById('bulkAddCardsModalTitle');
            const bulkAddCardsListIdInput = document.getElementById('bulkAddCardsListId');
            const bulkCardTitlesInput = document.getElementById('bulkCardTitles');
            const saveBulkAddCardsBtn = document.getElementById('saveBulkAddCardsBtn');
            const cardDetailsModal = document.getElementById('cardDetailsModal');
            const cardModalTitleEl = document.getElementById('cardModalTitle');
            const cardModalIdInput = document.getElementById('cardModalId');
            const cardModalListIdInput = document.getElementById('cardModalListId');
            const cardModalBoardIdInput = document.getElementById('cardModalBoardId');
            const cardTitleInput = document.getElementById('cardTitle');
            const cardDescriptionInput = document.getElementById('cardDescription');
            const cardDescriptionPreview = document.getElementById('cardDescriptionPreview');
            const cardDueDateInput = document.getElementById('cardDueDate');
            const cardDueTimeInput = document.getElementById('cardDueTime');
            const cardLabelsInput = document.getElementById('cardLabelsInput');
            const cardLabelsContainer = document.getElementById('cardLabelsContainer');
            const cardPrioritySelect = document.getElementById('cardPriority');
            const cardAssignedUserInput = document.getElementById('cardAssignedUserInput');
            const cardAssignedUserContainer = document.getElementById('cardAssignedUserContainer');
            const cardChecklistsContainer = document.getElementById('cardChecklistsContainer');
            const addChecklistBtn = document.getElementById('addChecklistBtn');
            const cardAttachmentInput = document.getElementById('cardAttachmentInput');
            const cardAttachmentsContainer = document.getElementById('cardAttachmentsContainer');
            const cardCommentsContainer = document.getElementById('cardCommentsContainer');
            const newCommentText = document.getElementById('newCommentText');
            const addCommentBtn = document.getElementById('addCommentBtn');
            const saveCardBtn = document.getElementById('saveCardBtn');
            const archiveCardBtn = document.getElementById('archiveCardBtn');
            const deleteCardBtn = document.getElementById('deleteCardBtn');
            const timeTrackerBtn = document.getElementById('timeTrackerBtn');
            const timeTrackedDisplay = document.getElementById('timeTrackedDisplay');
            const cardCustomFieldsContainer = document.getElementById('cardCustomFieldsContainer');
            const settingsModal = document.getElementById('settingsModal');
            const boardExportBtn = document.getElementById('boardExportBtn');
            const boardImportInput = document.getElementById('boardImportInput');
            const boardImportBtn = document.getElementById('boardImportBtn');
            const exportAllBoardsBtn = document.getElementById('exportAllBoardsBtn');
            const importAllBoardsInput = document.getElementById('importAllBoardsInput');
            const importAllBoardsBtn = document.getElementById('importAllBoardsBtn');
            const localStorageUsageEl = document.getElementById('localStorageUsage');
            const clearAllDataBtn = document.getElementById('clearAllDataBtn');
            const viewArchivedCardsBtn = document.getElementById('viewArchivedCardsBtn');
            const archivedCardsModal = document.getElementById('archivedCardsModal');
            const archivedCardsModalTitle = document.getElementById('archivedCardsModalTitle');
            const archivedCardsListContainer = document.getElementById('archivedCardsListContainer');
            const activityLogModal = document.getElementById('activityLogModal');
            const activityLogModalTitle = document.getElementById('activityLogModalTitle');
            const activityLogContainer = document.getElementById('activityLogContainer');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            let confirmActionCallback = null;
            const messageModal = document.getElementById('messageModal');
            const messageModalTitle = document.getElementById('messageModalTitle');
            const messageModalText = document.getElementById('messageModalText');

            // --- State ---
            let appData = {
                boards: [],
                settings: { currentBoardId: null, theme: 'light', notificationsEnabled: false },
                nextId: { board: 1, list: 1, card: 1, checklist: 1, checklistItem: 1, comment: 1, attachment: 1, customFieldDef: 1 }
            };
            let currentlyDraggingCardInfo = null; 
            let cardModalTempData = { checklists: [], attachments: [], comments: [], timeTracked: 0, timerInterval: null };
            let calendarDate = new Date();

            // --- Utility Functions ---
            const generateId = (type) => { if (!appData.nextId[type]) appData.nextId[type] = 1; return `bm-${type}-${appData.nextId[type]++}`; }
            const deepCopy = (obj) => JSON.parse(JSON.stringify(obj)); 
            const saveState = () => { try { localStorage.setItem('boardMasterData', JSON.stringify(appData)); updateLocalStorageUsage(); } catch (e) { console.error("Error saving state:", e); showMessage("Error Saving Data", "Could not save data."); }};
            const loadState = () => {
                try {
                    const data = localStorage.getItem('boardMasterData');
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (parsedData && Array.isArray(parsedData.boards) && parsedData.settings && parsedData.nextId) {
                            appData = parsedData;
                            if (appData.settings.notificationsEnabled === undefined) appData.settings.notificationsEnabled = false;
                            // Ensure all boards have a filters object
                            appData.boards.forEach(board => {
                                if (!board.filters) {
                                    board.filters = { text: '', labels: [], assignees: [], dueDate: 'any' };
                                }
                            });
                        } else { console.warn("Loaded data format error. Resetting."); }
                        const defaultNextIdKeys = ['board', 'list', 'card', 'checklist', 'checklistItem', 'comment', 'attachment', 'customFieldDef'];
                        defaultNextIdKeys.forEach(key => { if (!appData.nextId[key]) appData.nextId[key] = 1; });
                    }
                } catch (e) { console.error("Error loading state:", e); showMessage("Error Loading Data", "Could not load data. Starting fresh."); }
            };
            const updateLocalStorageUsage = () => { if (!localStorageUsageEl) return; try { const data = localStorage.getItem('boardMasterData'); if (data) { const sizeInBytes = new TextEncoder().encode(data).length; const sizeInKB = (sizeInBytes / 1024).toFixed(2); const sizeInMB = (sizeInKB / 1024).toFixed(2); localStorageUsageEl.textContent = `Est. storage: ${sizeInKB} KB (${sizeInMB} MB). Limit ~5-10MB.`; } else { localStorageUsageEl.textContent = "No data stored yet."; } } catch (e) { console.error("Could not calculate LocalStorage usage:", e); localStorageUsageEl.textContent = "Could not calculate storage usage."; } };

            // --- Modal Management ---
            const openModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.add('active'); };
            const closeModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('active'); if (modalId === 'cardDetailsModal' && cardModalTempData.timerInterval) { clearInterval(cardModalTempData.timerInterval); cardModalTempData.timerInterval = null; }};
            document.querySelectorAll('.close-btn').forEach(btn => { btn.addEventListener('click', (e) => { const modalId = e.currentTarget.dataset.modalId; if (modalId) closeModal(modalId); }); });
            window.addEventListener('click', (event) => {  document.querySelectorAll('.modal.active').forEach(modal => { if (event.target === modal) closeModal(modal.id); }); });
            const showConfirmation = (title, message, callback) => { confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message; confirmActionCallback = callback; openModal('confirmationModal'); };
            if(confirmActionBtn) confirmActionBtn.addEventListener('click', () => { if (confirmActionCallback) { try { confirmActionCallback(); } catch (e) { console.error("Confirm callback error:", e); showMessage("Error", "Action failed."); }} closeModal('confirmationModal'); confirmActionCallback = null; });
            const showMessage = (title, text) => { if(messageModalTitle) messageModalTitle.textContent = title; if(messageModalText) messageModalText.textContent = text; openModal('messageModal'); };

            // --- Notifications ---
            const updateNotificationsButton = () => { if (!notificationsToggleBtn) return; if (appData.settings.notificationsEnabled && Notification.permission === 'granted') { notificationsToggleBtn.textContent = 'Disable Notifications'; notificationsToggleBtn.classList.remove('btn-secondary'); notificationsToggleBtn.classList.add('btn-success'); } else { notificationsToggleBtn.textContent = 'Enable Notifications'; notificationsToggleBtn.classList.remove('btn-success'); notificationsToggleBtn.classList.add('btn-secondary'); if (Notification.permission === 'denied') { notificationsToggleBtn.disabled = true; notificationsToggleBtn.title = "Notifications are blocked by your browser."; } else { notificationsToggleBtn.disabled = false; notificationsToggleBtn.title = ""; } } };
            const requestNotificationPermission = async () => { if (!('Notification' in window)) { showMessage("Notifications Not Supported", "This browser does not support desktop notifications."); appData.settings.notificationsEnabled = false; updateNotificationsButton(); return false; } if (Notification.permission === 'granted') { appData.settings.notificationsEnabled = true; updateNotificationsButton(); return true; } if (Notification.permission !== 'denied') { try { const permission = await Notification.requestPermission(); appData.settings.notificationsEnabled = (permission === 'granted'); if(permission === 'granted') { showMessage("Notifications Enabled", "Desktop notifications for due dates are now active."); } else if (permission === 'denied') { showMessage("Notifications Blocked", "Notifications have been blocked. You can manage this in your browser settings."); } saveState(); updateNotificationsButton(); return appData.settings.notificationsEnabled; } catch(e) { console.error("Error requesting notification permission:", e); appData.settings.notificationsEnabled = false; updateNotificationsButton(); return false; } } else { appData.settings.notificationsEnabled = false; updateNotificationsButton(); } return false; };
            if (notificationsToggleBtn) { notificationsToggleBtn.addEventListener('click', async () => { if (appData.settings.notificationsEnabled && Notification.permission === 'granted') { appData.settings.notificationsEnabled = false; showMessage("Notifications Disabled", "Desktop notifications have been turned off within the app."); } else { await requestNotificationPermission(); } saveState(); updateNotificationsButton(); }); }
            const showNotification = (title, body, cardId, listId) => { if (!appData.settings.notificationsEnabled || Notification.permission !== 'granted') return; try { const notification = new Notification(title, { body, tag: cardId, icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADTSURBVDhPzZJRDcIwDEQzD2AEGMARjMAIjMAGzABGZgS2YAMrMAEZwBGcEASJg5KkuPeR/N27f5MDBYTCdyYgIQkY2gIyMAEZqL8B8zH8kI4gLCQ/gJ7pmdZLIMs8f8CVuR5MDsbbwHxGUpB1D07Nq2ddhpVtKZyZFDev8AOX8h6G2xLpLHzqfUK6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqfUL6xJpLHzqf0L/oR6K8Nv8B3dYQ2ZgJ2hYAAAAASUVORK5CYII=' }); notification.onclick = () => { const board = getCurrentBoard(); if(board && cardModalBoardIdInput && board.id === cardModalBoardIdInput.value && cardDetailsModal.classList.contains('active')) { /* Card already open, maybe just focus? */ } else if (board && appData.settings.currentBoardId === board.id) { openCardDetails(cardId, listId); } else { /* Could switch board and open, or show message */ showMessage("Card Notification", `Card "${title}" is on board "${board ? board.name : 'Unknown'}".`); } window.focus(); }; } catch (e) { console.error("Error showing notification:", e); } };
            const checkOverdueCardsAndNotify = () => { const board = getCurrentBoard(); if (!board || !appData.settings.notificationsEnabled) return; const now = new Date(); board.lists.forEach(list => { list.cards.forEach(card => { if (card.dueDate && !card.archived) { const dueDate = new Date(card.dueDate); if (dueDate < now && !card.notifiedOverdue) { showNotification(`Overdue: ${card.title}`, `Card "${card.title}" in list "${list.name}" is overdue.`, card.id, list.id); card.notifiedOverdue = true; } } }); }); };

            // --- Activity Log ---
            const logActivity = (boardId, message) => { if (!boardId) { console.warn("logActivity called without boardId"); return; } const board = appData.boards.find(b => b.id === boardId); if (!board) return; if (!board.activityLog) board.activityLog = []; board.activityLog.unshift({ timestamp: new Date().toISOString(), message: message }); if (board.activityLog.length > 100) board.activityLog.pop(); /* saveState(); // Avoid saving state for every log */ };
            const renderActivityLog = () => { if (!activityLogContainer) return; const board = getCurrentBoard(); activityLogContainer.innerHTML = ''; if (!board || !board.activityLog || board.activityLog.length === 0) { activityLogContainer.innerHTML = '<p>No activity recorded for this board yet.</p>'; return; } board.activityLog.forEach(log => { const itemEl = document.createElement('div'); itemEl.classList.add('activity-log-item'); itemEl.innerHTML = `<div class="activity-log-info">${log.message}</div><div class="timestamp">${new Date(log.timestamp).toLocaleString()}</div>`; activityLogContainer.appendChild(itemEl); }); };
            if(boardActivityLogBtn) boardActivityLogBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) { showMessage("Error", "Please select a board to view its activity."); return; } if(activityLogModalTitle) activityLogModalTitle.textContent = `Activity Log: ${board.name}`; renderActivityLog(); openModal('activityLogModal'); });

            // --- Theme Management ---
            const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); appData.settings.theme = theme; if (themeSelector) themeSelector.value = theme; saveState(); };
            if (themeSelector) themeSelector.addEventListener('change', (e) => applyTheme(e.target.value));

            // --- Board Functions ---
            const getCurrentBoard = () => appData.boards.find(b => b.id === appData.settings.currentBoardId);
            const renderBoardSelector = () => { if (!boardSelector) return; boardSelector.innerHTML = '<option value="">Select a Board...</option>'; const boardSelected = appData.boards.length > 0 && appData.settings.currentBoardId; if (appData.boards.length === 0) { if(welcomeScreen) welcomeScreen.classList.remove('hidden'); if(listsContainer) listsContainer.innerHTML = '';  if(currentBoardTitleEl) currentBoardTitleEl.textContent = 'No Board Selected'; } else { if(welcomeScreen) welcomeScreen.classList.add('hidden'); appData.boards.forEach(board => { const option = document.createElement('option'); option.value = board.id; option.textContent = board.name; if (board.id === appData.settings.currentBoardId) option.selected = true; boardSelector.appendChild(option); }); } [addListBtn, viewCalendarBtn, viewTableBtn, viewAnalyticsBtn, boardActivityLogBtn, viewArchivedCardsBtn, filterCardsBtn].forEach(btn => {  if(btn) btn.disabled = !boardSelected;  }); updateFilterButtonState(); };
            const selectBoard = (boardId) => { appData.settings.currentBoardId = boardId; const board = getCurrentBoard(); if (board) { if(currentBoardTitleEl) currentBoardTitleEl.textContent = board.name; if(listsContainer) listsContainer.style.backgroundColor = board.bgColor || 'var(--primary-bg)'; if (!board.filters) board.filters = { text: '', labels: [], assignees: [], dueDate: 'any' }; renderLists(); } else { if(currentBoardTitleEl) currentBoardTitleEl.textContent = 'No Board Selected'; if(listsContainer) { listsContainer.innerHTML = ''; listsContainer.style.backgroundColor = 'var(--primary-bg)'; } } saveState(); renderBoardSelector(); checkOverdueCardsAndNotify(); };
            if (boardSelector) boardSelector.addEventListener('change', (e) => { if (e.target.value) { selectBoard(e.target.value); switchView('kanban'); } else { selectBoard(null); }});
            const handleNewBoard = () => { if(boardModalIdInput) boardModalIdInput.value = ''; if(boardNameInput) boardNameInput.value = ''; if(boardDescriptionInput) boardDescriptionInput.value = ''; if(boardBgColorInput) boardBgColorInput.value = '#0079bf';  if(boardModalTitle) boardModalTitle.textContent = 'Create New Board'; openModal('boardModal'); };
            if(newBoardBtn) newBoardBtn.addEventListener('click', handleNewBoard);
            if(welcomeNewBoardBtn) welcomeNewBoardBtn.addEventListener('click', handleNewBoard);
            if(saveBoardBtn) saveBoardBtn.addEventListener('click', () => { const id = boardModalIdInput.value; const name = boardNameInput.value.trim(); const description = boardDescriptionInput.value.trim(); const bgColor = boardBgColorInput.value; if (!name) { showMessage('Validation Error', 'Board name is required.'); return; } let boardToSelect = appData.settings.currentBoardId; let actionMessage = ""; if (id) {  const board = appData.boards.find(b => b.id === id); if (board) { board.name = name; board.description = description; board.bgColor = bgColor; boardToSelect = board.id; actionMessage = `Board "${name}" updated.`; logActivity(board.id, `Board details updated for "${name}".`); } } else {  const newBoard = { id: generateId('board'), name, description, bgColor, lists: [], archivedCards: [], customFieldDefinitions: [], activityLog: [], filters: { text: '', labels: [], assignees: [], dueDate: 'any' } }; appData.boards.push(newBoard); boardToSelect = newBoard.id;  actionMessage = `Board "${name}" created.`; logActivity(newBoard.id, `Board "${name}" was created.`); } saveState(); renderBoardSelector(); selectBoard(boardToSelect);  showMessage("Success", actionMessage); closeModal('boardModal'); });
            
            // --- List Functions ---
            const renderLists = () => { if (!listsContainer) return; listsContainer.innerHTML = ''; const board = getCurrentBoard(); if (!board) return; board.lists.forEach(list => { const listEl = document.createElement('div'); listEl.classList.add('list'); listEl.dataset.listId = list.id; listEl.innerHTML = `<div class="list-header"><h3 data-list-id="${list.id}" title="Double-click to edit list name">${list.name}</h3><div class="list-actions"><button class="list-menu-btn" data-list-id="${list.id}" title="List Actions">⋮</button><div class="list-dropdown-menu" data-list-id="${list.id}"><button class="edit-list-name-btn" data-list-id="${list.id}">Edit Name</button><button class="bulk-add-cards-to-list-btn" data-list-id="${list.id}">Bulk Add Cards</button><button class="delete-list-btn" data-list-id="${list.id}">Delete List</button></div></div></div><div class="cards-container" data-list-id="${list.id}"></div><button class="add-card-btn add-item-btn" data-list-id="${list.id}">+ Add Card</button><div class="add-item-form add-card-form hidden" data-list-id="${list.id}"><input type="text" placeholder="Enter card title..."><div class="add-item-form-actions"><button class="save-new-card-btn btn btn-primary btn-sm">Add Card</button><button class="cancel-new-card-btn btn btn-secondary btn-sm">Cancel</button></div></div>`; listsContainer.appendChild(listEl); renderCards(list.id); const listTitleEl = listEl.querySelector('.list-header h3'); listTitleEl.addEventListener('dblclick', () => { listTitleEl.contentEditable = "true"; listTitleEl.focus(); document.execCommand('selectAll',false,null); }); listTitleEl.addEventListener('blur', () => { listTitleEl.contentEditable = "false"; const newName = listTitleEl.textContent.trim(); if (newName && newName !== list.name) { logActivity(board.id, `List name changed from "${list.name}" to "${newName}".`); list.name = newName; saveState(); } else { listTitleEl.textContent = list.name; } }); listTitleEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); listTitleEl.blur(); } else if (e.key === 'Escape') { listTitleEl.textContent = list.name; listTitleEl.blur(); } }); }); initializeListDragDrop(); };
            function initializeListDragDrop() { let draggedListElement = null; if(!listsContainer) return; listsContainer.querySelectorAll('.list').forEach(listEl => { listEl.draggable = true; listEl.addEventListener('dragstart', (e) => { draggedListElement = listEl; setTimeout(() => listEl.classList.add('dragging'), 0);  }); listEl.addEventListener('dragend', (e) => { if (draggedListElement) { draggedListElement.classList.remove('dragging'); } draggedListElement = null; updateListOrder(); }); }); listsContainer.addEventListener('dragover', (e) => { e.preventDefault(); if (!draggedListElement) return; const afterElement = getDragAfterElement(listsContainer, e.clientX, '.list:not(.dragging)'); if (afterElement == null) { listsContainer.appendChild(draggedListElement); } else { listsContainer.insertBefore(draggedListElement, afterElement); } }); }
            const updateListOrder = () => { const board = getCurrentBoard(); if (!board || !listsContainer) return; const oldOrderNames = board.lists.map(l => l.name); const newListOrderIds = Array.from(listsContainer.querySelectorAll('.list')).map(el => el.dataset.listId); board.lists.sort((a, b) => newListOrderIds.indexOf(a.id) - newListOrderIds.indexOf(b.id)); const newOrderNames = board.lists.map(l => l.name); if(JSON.stringify(oldOrderNames) !== JSON.stringify(newOrderNames)) logActivity(board.id, `List order changed.`); saveState(); };
            if(addListBtn) addListBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) { showMessage("Action Required", "Please select or create a board first."); return; } if(listModalIdInput) listModalIdInput.value = ''; if(listModalBoardIdInput) listModalBoardIdInput.value = board.id; if(listNameInput) listNameInput.value = ''; if(listModalTitle) listModalTitle.textContent = 'Create New List'; openModal('listModal'); });
            if(saveListBtn) saveListBtn.addEventListener('click', () => { const boardId = listModalBoardIdInput.value; const listId = listModalIdInput.value; const name = listNameInput.value.trim(); if (!name) { showMessage('Validation Error', 'List name is required.'); return; } const board = appData.boards.find(b => b.id === boardId); if (!board) return; if (listId) {  const list = board.lists.find(l => l.id === listId);  if (list && list.name !== name) { logActivity(board.id, `List renamed from "${list.name}" to "${name}".`); list.name = name;  } } else {  const newList = { id: generateId('list'), name, cards: [] }; board.lists.push(newList); logActivity(board.id, `List "${name}" created.`); } saveState(); renderLists(); closeModal('listModal'); });
            if(listsContainer) listsContainer.addEventListener('click', (e) => {
                const listMenuBtn = e.target.closest('.list-menu-btn');
                if (listMenuBtn) {
                    const listId = listMenuBtn.dataset.listId;
                    const currentDropdown = document.querySelector(`.list-dropdown-menu[data-list-id="${listId}"]`);
                    const isActive = currentDropdown && currentDropdown.classList.contains('active');
                    document.querySelectorAll('.list-dropdown-menu.active').forEach(menu => { if (menu !== currentDropdown) menu.classList.remove('active'); });
                    if (currentDropdown) currentDropdown.classList.toggle('active', !isActive);
                    return; 
                }
                // Inline add card form logic
                if (e.target.classList.contains('add-card-btn')) { const listId = e.target.dataset.listId; const form = document.querySelector(`.add-card-form[data-list-id="${listId}"]`); if (form) { form.classList.remove('hidden'); const input = form.querySelector('input[type="text"]'); if (input) input.focus(); e.target.classList.add('hidden'); } }
                if (e.target.classList.contains('cancel-new-card-btn')) { const listId = e.target.closest('.add-card-form').dataset.listId; const form = document.querySelector(`.add-card-form[data-list-id="${listId}"]`); const addBtn = document.querySelector(`.add-card-btn[data-list-id="${listId}"]`); if (form) { form.classList.add('hidden'); const input = form.querySelector('input[type="text"]'); if (input) input.value = '';  } if (addBtn) addBtn.classList.remove('hidden'); }
                if (e.target.classList.contains('save-new-card-btn')) { const listId = e.target.closest('.add-card-form').dataset.listId; const input = e.target.closest('.add-card-form').querySelector('input[type="text"]'); const title = input.value.trim(); if (title) { const board = getCurrentBoard(); if(!board) return; const list = board.lists.find(l => l.id === listId); if (list) { const newCard = createNewCardObject(title, listId, board.id); list.cards.push(newCard); logActivity(board.id, `Card "${title}" created in list "${list.name}".`); saveState(); renderCards(listId); input.value = ''; input.focus();  } } else { showMessage("Validation Error", "Card title cannot be empty."); input.focus(); } }
                // Dropdown menu item clicks
                const dropdownItem = e.target.closest('.list-dropdown-menu button');
                if (dropdownItem) {
                    const listId = dropdownItem.dataset.listId;
                    const board = getCurrentBoard();
                    if (!board) return;
                    const list = board.lists.find(l => l.id === listId);

                    if (dropdownItem.classList.contains('edit-list-name-btn')) { const listHeader = document.querySelector(`.list[data-list-id="${listId}"] .list-header h3`); if(listHeader) { listHeader.contentEditable = "true"; listHeader.focus(); document.execCommand('selectAll',false,null); } }
                    else if (dropdownItem.classList.contains('bulk-add-cards-to-list-btn')) { if(bulkAddCardsListIdInput) bulkAddCardsListIdInput.value = listId; if(list && bulkAddCardsModalTitle) bulkAddCardsModalTitle.textContent = `Bulk Add Cards to: ${list.name}`; if(bulkCardTitlesInput) bulkCardTitlesInput.value = ''; openModal('bulkAddCardsModal'); }
                    else if (dropdownItem.classList.contains('delete-list-btn')) { showConfirmation('Delete List', 'Are you sure you want to delete this list and all its cards? This action cannot be undone.', () => { if (list) logActivity(board.id, `List "${list.name}" and its cards deleted.`); board.lists = board.lists.filter(l => l.id !== listId); saveState(); renderLists(); }); }
                    dropdownItem.closest('.list-dropdown-menu').classList.remove('active');
                }
            });
            if(saveBulkAddCardsBtn) saveBulkAddCardsBtn.addEventListener('click', () => { const listId = bulkAddCardsListIdInput.value; const titlesText = bulkCardTitlesInput.value.trim(); if (!titlesText) { showMessage("Input Needed", "Please enter card titles."); return; } const board = getCurrentBoard(); if(!board) return; const list = board.lists.find(l => l.id === listId); if(!list) return; const titles = titlesText.split('\n').map(t => t.trim()).filter(t => t); if (titles.length === 0) { showMessage("Input Needed", "No valid card titles entered."); return; } titles.forEach(title => { const newCard = createNewCardObject(title, listId, board.id); list.cards.push(newCard); logActivity(board.id, `Card "${title}" bulk added to list "${list.name}".`); }); saveState(); renderCards(listId); showMessage("Success", `${titles.length} card(s) added to list "${list.name}".`); closeModal('bulkAddCardsModal'); });

            // --- Card Functions ---
            const renderCards = (listId) => { const cardsContainerEl = document.querySelector(`.cards-container[data-list-id="${listId}"]`); if (!cardsContainerEl) return; cardsContainerEl.innerHTML = ''; const board = getCurrentBoard(); if (!board) return; const list = board.lists.find(l => l.id === listId); if (!list) return; const activeFilters = board.filters || { text: '', labels: [], assignees: [], dueDate: 'any' }; list.cards.forEach(card => { if (card.archived) return;  if (!cardMatchesFilters(card, activeFilters, board)) return; const cardEl = document.createElement('div'); cardEl.classList.add('card'); cardEl.dataset.cardId = card.id; cardEl.dataset.listId = listId; cardEl.draggable = true; let labelsHTML = '<div class="card-labels">'; if (card.labels && card.labels.length > 0) { card.labels.forEach(label => { labelsHTML += `<span class="card-label" style="background-color: ${getLabelColor(label.color || label.name)};" title="${label.name}">${label.name}</span>`; });} labelsHTML += '</div>'; let metaHTML = '<div class="card-meta">'; if (card.dueDate) { const dueDateObj = new Date(card.dueDate); const isOverdue = dueDateObj < new Date() && !isToday(dueDateObj); metaHTML += `<span title="Due Date" style="${isOverdue ? 'color: var(--danger-color); font-weight: bold;' : ''}">📅 ${dueDateObj.toLocaleDateString()}</span>`;} if (card.checklists && card.checklists.length > 0) { const totalItems = card.checklists.reduce((sum, cl) => sum + cl.items.length, 0); const completedItems = card.checklists.reduce((sum, cl) => sum + cl.items.filter(i => i.completed).length, 0); if (totalItems > 0) metaHTML += `<span title="Checklist Progress">✓ ${completedItems}/${totalItems}</span>`;} if (card.comments && card.comments.length > 0) metaHTML += `<span title="Comments">💬 ${card.comments.length}</span>`; if (card.attachments && card.attachments.length > 0) metaHTML += `<span title="Attachments">📎 ${card.attachments.length}</span>`; metaHTML += '</div>'; cardEl.innerHTML = `<div class="card-title">${card.title}</div>${labelsHTML}${metaHTML}`; cardEl.addEventListener('click', () => openCardDetails(card.id, listId)); cardsContainerEl.appendChild(cardEl); }); };
            const isToday = (someDate) => { const today = new Date(); return someDate.getDate() === today.getDate() && someDate.getMonth() === today.getMonth() && someDate.getFullYear() === today.getFullYear(); };
            const getLabelColor = (labelNameOrColor) => { const predefinedColors = { red: '#eb5a46', green: '#61bd4f', blue: '#0079bf', yellow: '#f2d600', orange: '#ff9f1a', purple: '#c377e0', black: '#344563', pink: '#ff78cb', sky: '#00c2e0', lime: '#51e898', default: '#b0bec5' }; const colorKey = labelNameOrColor ? labelNameOrColor.toLowerCase() : 'default'; return predefinedColors[colorKey] || labelNameOrColor; };
            if(listsContainer) listsContainer.addEventListener('dragstart', (e) => { if (e.target.classList.contains('card')) { currentlyDraggingCardInfo = { element: e.target, cardId: e.target.dataset.cardId, originalListId: e.target.dataset.listId }; e.dataTransfer.setData('text/plain', e.target.dataset.cardId); setTimeout(() => e.target.classList.add('dragging'), 0); } });
            if(listsContainer) listsContainer.addEventListener('dragend', (e) => { if (currentlyDraggingCardInfo && e.target === currentlyDraggingCardInfo.element) { e.target.classList.remove('dragging'); currentlyDraggingCardInfo = null; } });
            if(listsContainer) listsContainer.addEventListener('dragover', (e) => { e.preventDefault(); });
            if(listsContainer) listsContainer.addEventListener('drop', (e) => { e.preventDefault(); if (!currentlyDraggingCardInfo) return; const targetCardsContainer = e.target.closest('.cards-container'); if (!targetCardsContainer) return; const { cardId, originalListId } = currentlyDraggingCardInfo; const newListId = targetCardsContainer.dataset.listId; const board = getCurrentBoard(); if (!board) return; const originalList = board.lists.find(l => l.id === originalListId); const newList = board.lists.find(l => l.id === newListId); if (!originalList || !newList) return; const cardIndex = originalList.cards.findIndex(c => c.id === cardId); if (cardIndex === -1) return; const [cardToMove] = originalList.cards.splice(cardIndex, 1); const afterElement = getDragAfterElement(targetCardsContainer, e.clientY, '.card:not(.dragging)'); if (afterElement == null) { newList.cards.push(cardToMove); } else { const refIdx = newList.cards.findIndex(c => c.id === afterElement.dataset.cardId); newList.cards.splice(refIdx, 0, cardToMove); } cardToMove.lastModified = new Date().toISOString(); if (originalListId !== newListId) { logActivity(board.id, `Card "${cardToMove.title}" moved from list "${originalList.name}" to "${newList.name}".`); } else { logActivity(board.id, `Card "${cardToMove.title}" reordered in list "${newList.name}".`); } saveState(); renderCards(originalListId);  if (originalListId !== newListId) renderCards(newListId); currentlyDraggingCardInfo = null;  });
            function getDragAfterElement(container, y, selector) { const draggableElements = [...container.querySelectorAll(selector)]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
            const createNewCardObject = (title, listId, boardId) => { const board = appData.boards.find(b => b.id === boardId); const newCard = { id: generateId('card'), title, description: '', dueDate: null, labels: [], checklists: [], attachments: [], comments: [], priority: 'medium', assignedUsers: [], customFields: {}, createdAt: new Date().toISOString(), lastModified: new Date().toISOString(), archived: false, timeTracked: 0, notifiedOverdue: false }; if (board && board.customFieldDefinitions) { board.customFieldDefinitions.forEach(cfDef => { newCard.customFields[cfDef.id] = cfDef.type === 'number' ? 0 : (cfDef.type === 'dropdown' ? (cfDef.options?.[0] || '') : ''); }); } return newCard; };

            // --- Card Details Modal ---
            const openCardDetails = (cardId, listId) => { if (cardModalTempData.timerInterval) { clearInterval(cardModalTempData.timerInterval); cardModalTempData.timerInterval = null; } const board = getCurrentBoard(); if(!board) return; const list = board.lists.find(l => l.id === listId); if(!list) return; const card = list.cards.find(c => c.id === cardId); if (!card) return; cardModalTempData = { checklists: deepCopy(card.checklists || []), attachments: deepCopy(card.attachments || []), comments: deepCopy(card.comments || []), timeTracked: card.timeTracked || 0, timerInterval: null }; if(cardModalIdInput) cardModalIdInput.value = card.id; if(cardModalListIdInput) cardModalListIdInput.value = listId; if(cardModalBoardIdInput) cardModalBoardIdInput.value = board.id; if(cardModalTitleEl) cardModalTitleEl.textContent = `Edit Card: ${card.title}`;  if(cardTitleInput) cardTitleInput.value = card.title; if(cardDescriptionInput) cardDescriptionInput.value = card.description || ''; renderMarkdownPreview(card.description || ''); if (card.dueDate) { try { const date = new Date(card.dueDate); if(cardDueDateInput) cardDueDateInput.value = date.toISOString().split('T')[0]; if(cardDueTimeInput) cardDueTimeInput.value = date.toTimeString().split(' ')[0].substring(0,5); } catch (e) { console.error("Error parsing due date:", e); if(cardDueDateInput) cardDueDateInput.value = ''; if(cardDueTimeInput) cardDueTimeInput.value = '';} } else { if(cardDueDateInput) cardDueDateInput.value = ''; if(cardDueTimeInput) cardDueTimeInput.value = ''; } if(cardLabelsInput) cardLabelsInput.value = card.labels ? card.labels.map(l => l.name).join(',') : ''; renderCardLabelsInModal(card.labels || []); if(cardPrioritySelect) cardPrioritySelect.value = card.priority || 'medium'; if(cardAssignedUserInput) cardAssignedUserInput.value = card.assignedUsers ? card.assignedUsers.join(',') : ''; renderCardAssignedUsersInModal(card.assignedUsers || []); renderChecklistsInModal(cardModalTempData.checklists); renderAttachmentsInModal(cardModalTempData.attachments); renderCommentsInModal(cardModalTempData.comments); renderCustomFieldsInModal(card.customFields || {}, board.customFieldDefinitions || []); updateTimeTrackedDisplay(cardModalTempData.timeTracked); if(timeTrackerBtn) { timeTrackerBtn.textContent = 'Start Timer'; timeTrackerBtn.classList.remove('btn-danger'); timeTrackerBtn.classList.add('btn-secondary');} openModal('cardDetailsModal'); };
            if(cardDescriptionInput) cardDescriptionInput.addEventListener('input', (e) => renderMarkdownPreview(e.target.value));
            function renderMarkdownPreview(mdText) { if(!cardDescriptionPreview) return; let html = mdText || ""; html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>').replace(/\n/g, '<br>'); cardDescriptionPreview.innerHTML = html; }
            function renderCardLabelsInModal(labels) { if(!cardLabelsContainer) return; cardLabelsContainer.innerHTML = ''; labels.forEach(label => { const span = document.createElement('span'); span.textContent = label.name; span.style.backgroundColor = getLabelColor(label.color || label.name); span.style.color = 'white';  cardLabelsContainer.appendChild(span); }); }
            function renderCardAssignedUsersInModal(users) { if(!cardAssignedUserContainer) return; cardAssignedUserContainer.innerHTML = ''; users.forEach(user => { const span = document.createElement('span'); span.textContent = user; span.style.backgroundColor = 'var(--tertiary-bg)'; span.style.color = 'var(--text-color)'; cardAssignedUserContainer.appendChild(span); }); }
            if(addChecklistBtn) addChecklistBtn.addEventListener('click', () => { const newChecklist = { id: generateId('checklist'), title: 'New Checklist', items: [] }; cardModalTempData.checklists.push(newChecklist); renderSingleChecklist(newChecklist, cardModalTempData.checklists.length - 1); });
            function renderChecklistsInModal(checklists) { if(!cardChecklistsContainer) return; cardChecklistsContainer.innerHTML = ''; checklists.forEach((checklist, index) => renderSingleChecklist(checklist, index)); }
            function renderSingleChecklist(checklist, checklistIndex) { const checklistDiv = document.createElement('div'); checklistDiv.classList.add('checklist-group', 'mb-1'); checklistDiv.dataset.checklistId = checklist.id; checklistDiv.dataset.checklistIndex = checklistIndex; checklistDiv.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;"><input type="text" class="checklist-title-input" value="${checklist.title}" placeholder="Checklist Title" style="font-weight: bold; border:1px solid var(--border-color); background:var(--secondary-bg); width: 80%; padding: 5px;"><button class="delete-checklist-btn btn btn-danger btn-sm" title="Delete Checklist">Delete</button></div><div class="checklist-items-container"></div><button class="add-checklist-item-btn btn btn-secondary btn-sm mt-1" title="Add Item to Checklist">+ Item</button>`; if(cardChecklistsContainer) cardChecklistsContainer.appendChild(checklistDiv); const itemsContainer = checklistDiv.querySelector('.checklist-items-container'); checklist.items.forEach((item, itemIndex) => renderSingleChecklistItem(item, itemsContainer, checklistIndex, itemIndex)); const titleInput = checklistDiv.querySelector('.checklist-title-input'); if(titleInput) titleInput.addEventListener('change', (e) => { if(cardModalTempData.checklists[checklistIndex]) cardModalTempData.checklists[checklistIndex].title = e.target.value.trim(); }); const addItemBtn = checklistDiv.querySelector('.add-checklist-item-btn'); if(addItemBtn) addItemBtn.addEventListener('click', () => { const newItem = { id: generateId('checklistItem'), text: '', completed: false }; if(cardModalTempData.checklists[checklistIndex]) cardModalTempData.checklists[checklistIndex].items.push(newItem); renderSingleChecklistItem(newItem, itemsContainer, checklistIndex, cardModalTempData.checklists[checklistIndex].items.length - 1); }); const deleteChecklistBtn = checklistDiv.querySelector('.delete-checklist-btn'); if(deleteChecklistBtn) deleteChecklistBtn.addEventListener('click', () => { cardModalTempData.checklists.splice(checklistIndex, 1); renderChecklistsInModal(cardModalTempData.checklists); }); }
            function renderSingleChecklistItem(item, container, checklistIndex, itemIndex) { const itemDiv = document.createElement('div'); itemDiv.classList.add('checklist-item'); itemDiv.dataset.itemId = item.id; itemDiv.dataset.itemIndex = itemIndex; itemDiv.innerHTML = `<input type="checkbox" ${item.completed ? 'checked' : ''}><input type="text" value="${item.text}" placeholder="Checklist item"><button class="delete-checklist-item-btn" title="Delete item">&times;</button>`; if(container) container.appendChild(itemDiv); const checkbox = itemDiv.querySelector('input[type="checkbox"]'); if(checkbox) checkbox.addEventListener('change', (e) => { if(cardModalTempData.checklists[checklistIndex] && cardModalTempData.checklists[checklistIndex].items[itemIndex]) cardModalTempData.checklists[checklistIndex].items[itemIndex].completed = e.target.checked; }); const textInput = itemDiv.querySelector('input[type="text"]'); if(textInput) textInput.addEventListener('change', (e) => { if(cardModalTempData.checklists[checklistIndex] && cardModalTempData.checklists[checklistIndex].items[itemIndex]) cardModalTempData.checklists[checklistIndex].items[itemIndex].text = e.target.value.trim(); }); const deleteItemBtn = itemDiv.querySelector('.delete-checklist-item-btn'); if(deleteItemBtn) deleteItemBtn.addEventListener('click', () => { if(cardModalTempData.checklists[checklistIndex]) cardModalTempData.checklists[checklistIndex].items.splice(itemIndex, 1); if(container) { container.innerHTML = ''; cardModalTempData.checklists[checklistIndex].items.forEach((it, idx) => renderSingleChecklistItem(it, container, checklistIndex, idx)); } }); }
            if(cardAttachmentInput) cardAttachmentInput.addEventListener('change', (e) => { const files = e.target.files; for (let file of files) { if (file.size > 1 * 1024 * 1024) { showMessage("File Too Large", `File "${file.name}" is too large (max 1MB). It was not added.`); continue; } const reader = new FileReader(); reader.onload = (event) => { const newAttachment = { id: generateId('attachment'), name: file.name, type: file.type, size: file.size, data: event.target.result }; cardModalTempData.attachments.push(newAttachment); renderSingleAttachment(newAttachment, cardModalTempData.attachments.length - 1); }; reader.onerror = () => { showMessage("File Read Error", `Could not read file "${file.name}".`); }; reader.readAsDataURL(file); } if(cardAttachmentInput) cardAttachmentInput.value = ''; });
            function renderAttachmentsInModal(attachments) { if(!cardAttachmentsContainer) return; cardAttachmentsContainer.innerHTML = ''; attachments.forEach((att, index) => renderSingleAttachment(att, index)); }
            function renderSingleAttachment(attachment, attachmentIndex) { const attDiv = document.createElement('div'); attDiv.classList.add('attachment-item'); attDiv.dataset.attachmentId = attachment.id; attDiv.dataset.attachmentIndex = attachmentIndex; let previewOrLink; if (attachment.type.startsWith('image/')) { previewOrLink = `<img src="${attachment.data}" alt="${attachment.name}" class="attachment-preview"> <a href="${attachment.data}" download="${attachment.name}" title="Download ${attachment.name}">${attachment.name}</a>`; } else { previewOrLink = `<a href="${attachment.data}" download="${attachment.name}" title="Download ${attachment.name}">${attachment.name}</a>`; } attDiv.innerHTML = `<span>${previewOrLink} (${(attachment.size / 1024).toFixed(1)} KB)</span><button class="delete-attachment-btn btn btn-danger btn-sm" title="Delete Attachment">Delete</button>`; if(cardAttachmentsContainer) cardAttachmentsContainer.appendChild(attDiv); const deleteAttBtn = attDiv.querySelector('.delete-attachment-btn'); if(deleteAttBtn) deleteAttBtn.addEventListener('click', () => { cardModalTempData.attachments.splice(attachmentIndex, 1); renderAttachmentsInModal(cardModalTempData.attachments); }); }
            if(addCommentBtn) addCommentBtn.addEventListener('click', () => { const text = newCommentText.value.trim(); if (text) { const newComment = { id: generateId('comment'), userId: 'currentUser', userName: 'You', text: text, timestamp: new Date().toISOString() }; cardModalTempData.comments.unshift(newComment); renderCommentsInModal(cardModalTempData.comments); if(newCommentText) newCommentText.value = ''; } else { showMessage("Validation Error", "Comment text cannot be empty."); } });
            function renderCommentsInModal(comments) { if(!cardCommentsContainer) return; cardCommentsContainer.innerHTML = ''; comments.forEach(comment => renderSingleComment(comment)); }
            function renderSingleComment(comment) { const commentDiv = document.createElement('div'); commentDiv.classList.add('comment'); commentDiv.dataset.commentId = comment.id; commentDiv.innerHTML = `<div class="comment-meta"><strong>${comment.userName || 'User'}</strong> at ${new Date(comment.timestamp).toLocaleString()}</div><p>${comment.text.replace(/\n/g, '<br>')}</p>`; if(cardCommentsContainer) cardCommentsContainer.appendChild(commentDiv); }
            function renderCustomFieldsInModal(customFieldsData, customFieldDefinitions) { if(!cardCustomFieldsContainer) return; cardCustomFieldsContainer.innerHTML = ''; if (!customFieldDefinitions || customFieldDefinitions.length === 0) { cardCustomFieldsContainer.innerHTML = '<p><small>No custom fields defined for this board.</small></p>'; return; } customFieldDefinitions.forEach(def => { const fieldDiv = document.createElement('div'); fieldDiv.classList.add('custom-field-item'); fieldDiv.dataset.customFieldDefId = def.id; let inputHtml = ''; const currentValue = customFieldsData[def.id] !== undefined ? customFieldsData[def.id] : (def.type === 'number' ? 0 : ''); switch(def.type) { case 'text': inputHtml = `<input type="text" id="cf-${def.id}" data-cf-id="${def.id}" value="${currentValue}" placeholder="${def.name}">`; break; case 'number': inputHtml = `<input type="number" id="cf-${def.id}" data-cf-id="${def.id}" value="${currentValue}" placeholder="${def.name}">`; break; case 'dropdown': let optionsHtml = (def.options || []).map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join(''); inputHtml = `<select id="cf-${def.id}" data-cf-id="${def.id}">${optionsHtml}</select>`; break; default: inputHtml = `<input type="text" id="cf-${def.id}" data-cf-id="${def.id}" value="${currentValue}" placeholder="${def.name} (unknown type)">`; } fieldDiv.innerHTML = `<label for="cf-${def.id}">${def.name}:</label>${inputHtml}`; cardCustomFieldsContainer.appendChild(fieldDiv); }); }
            if(timeTrackerBtn) timeTrackerBtn.addEventListener('click', () => { if (cardModalTempData.timerInterval) { clearInterval(cardModalTempData.timerInterval); cardModalTempData.timerInterval = null; timeTrackerBtn.textContent = 'Start Timer'; timeTrackerBtn.classList.remove('btn-danger'); timeTrackerBtn.classList.add('btn-secondary'); } else { const startTime = Date.now() - (cardModalTempData.timeTracked * 1000); cardModalTempData.timerInterval = setInterval(() => { cardModalTempData.timeTracked = Math.floor((Date.now() - startTime) / 1000); updateTimeTrackedDisplay(cardModalTempData.timeTracked); }, 1000); timeTrackerBtn.textContent = 'Stop Timer'; timeTrackerBtn.classList.remove('btn-secondary'); timeTrackerBtn.classList.add('btn-danger'); } });
            function updateTimeTrackedDisplay(trackedSeconds) { if(!timeTrackedDisplay) return; const hours = Math.floor(trackedSeconds / 3600); const minutes = Math.floor((trackedSeconds % 3600) / 60); const seconds = trackedSeconds % 60; timeTrackedDisplay.textContent = `Total: ${hours}h ${minutes}m ${seconds}s`; }
            if(saveCardBtn) saveCardBtn.addEventListener('click', () => { const cardId = cardModalIdInput.value; const listId = cardModalListIdInput.value; const boardId = cardModalBoardIdInput.value; const board = appData.boards.find(b => b.id === boardId); if(!board) return; const list = board.lists.find(l => l.id === listId); if(!list) return; const card = list.cards.find(c => c.id === cardId); if (!card) return; if (!cardTitleInput.value.trim()) { showMessage("Validation Error", "Card title cannot be empty."); return; } let activityMessages = []; if (card.title !== cardTitleInput.value.trim()) activityMessages.push(`title changed from "${card.title}" to "${cardTitleInput.value.trim()}"`); card.title = cardTitleInput.value.trim(); if (card.description !== cardDescriptionInput.value.trim()) activityMessages.push(`description updated`); card.description = cardDescriptionInput.value.trim(); const oldDueDate = card.dueDate; const dueDate = cardDueDateInput.value; const dueTime = cardDueTimeInput.value; if (dueDate) { card.dueDate = dueTime ? new Date(`${dueDate}T${dueTime}`).toISOString() : new Date(dueDate).toISOString(); } else { card.dueDate = null; } if (oldDueDate !== card.dueDate) { activityMessages.push(`due date ${card.dueDate ? 'set to ' + new Date(card.dueDate).toLocaleDateString() : 'cleared'}`); card.notifiedOverdue = false; } const newLabels = cardLabelsInput.value.split(',').map(name => name.trim()).filter(name => name).map(name => ({ name: name, color: getLabelColor(name) })); if (JSON.stringify(card.labels) !== JSON.stringify(newLabels)) activityMessages.push("labels updated"); card.labels = newLabels; if (card.priority !== cardPrioritySelect.value) activityMessages.push(`priority changed to ${cardPrioritySelect.value}`); card.priority = cardPrioritySelect.value; const newAssignedUsers = cardAssignedUserInput.value.split(',').map(u => u.trim()).filter(u => u); if (JSON.stringify(card.assignedUsers) !== JSON.stringify(newAssignedUsers)) activityMessages.push("assignees updated"); card.assignedUsers = newAssignedUsers; (cardModalTempData.checklists || []).forEach((tempCl, index) => { const originalCl = (card.checklists || [])[index]; if (!originalCl || originalCl.id !== tempCl.id) { activityMessages.push(`checklist "${tempCl.title}" added`); } else { if (originalCl.title !== tempCl.title) activityMessages.push(`checklist "${originalCl.title}" renamed to "${tempCl.title}"`); tempCl.items.forEach((tempItem, itemIndex) => { const originalItem = (originalCl.items || [])[itemIndex]; if (!originalItem || originalItem.id !== tempItem.id) { activityMessages.push(`item "${tempItem.text}" added to checklist "${tempCl.title}"`); } else { if (originalItem.text !== tempItem.text) activityMessages.push(`item in "${tempCl.title}" changed from "${originalItem.text}" to "${tempItem.text}"`); if (originalItem.completed !== tempItem.completed) activityMessages.push(`item "${tempItem.text}" in "${tempCl.title}" marked as ${tempItem.completed ? 'complete' : 'incomplete'}`); } }); if (originalCl.items.length > tempCl.items.length) activityMessages.push(`items removed from checklist "${tempCl.title}"`); } }); if ((card.checklists || []).length > (cardModalTempData.checklists || []).length) activityMessages.push(`checklists removed`); card.checklists = deepCopy(cardModalTempData.checklists); if (card.attachments.length !== cardModalTempData.attachments.length || !card.attachments.every((att, i) => att.id === cardModalTempData.attachments[i]?.id)) { activityMessages.push("attachments updated"); } card.attachments = deepCopy(cardModalTempData.attachments); if (card.comments.length < cardModalTempData.comments.length) { const newCommentsCount = cardModalTempData.comments.length - card.comments.length; activityMessages.push(`${newCommentsCount} new comment(s) added`); } card.comments = deepCopy(cardModalTempData.comments); card.timeTracked = cardModalTempData.timeTracked; if (cardModalTempData.timerInterval) { clearInterval(cardModalTempData.timerInterval); cardModalTempData.timerInterval = null; } const oldCustomFields = JSON.stringify(card.customFields); card.customFields = {}; if (cardCustomFieldsContainer) { cardCustomFieldsContainer.querySelectorAll('input[data-cf-id], select[data-cf-id]').forEach(inputEl => { const defId = inputEl.dataset.cfId; const fieldDef = board.customFieldDefinitions.find(d => d.id === defId); if (fieldDef) card.customFields[defId] = fieldDef.type === 'number' ? parseFloat(inputEl.value) : inputEl.value; }); } if (oldCustomFields !== JSON.stringify(card.customFields)) activityMessages.push("custom fields updated"); card.lastModified = new Date().toISOString(); if (activityMessages.length > 0) { logActivity(board.id, `Card "${card.title}": ${activityMessages.join('; ')}.`); } saveState(); renderCards(listId);  if (card.dueDate && !card.notifiedOverdue) {  const dueDateObj = new Date(card.dueDate); if (dueDateObj < new Date()) showNotification(`Overdue: ${card.title}`, `Card "${card.title}" in list "${list.name}" is overdue.`, card.id, list.id); } closeModal('cardDetailsModal'); });
            if(archiveCardBtn) archiveCardBtn.addEventListener('click', () => { const cardId = cardModalIdInput.value; const listId = cardModalListIdInput.value; const boardId = cardModalBoardIdInput.value; const board = appData.boards.find(b => b.id === boardId); if(!board) return; const list = board.lists.find(l => l.id === listId); if(!list) return; const cardIndex = list.cards.findIndex(c => c.id === cardId); if (cardIndex > -1) { const [cardToArchive] = list.cards.splice(cardIndex, 1); cardToArchive.archived = true; cardToArchive.archivedAt = new Date().toISOString(); cardToArchive.originalListIdBeforeArchive = listId; if (!board.archivedCards) board.archivedCards = []; board.archivedCards.push(cardToArchive); logActivity(board.id, `Card "${cardToArchive.title}" archived from list "${list.name}".`); saveState(); renderCards(listId); closeModal('cardDetailsModal'); showMessage("Card Archived", `Card "${cardToArchive.title}" has been archived.`); } });
            if(deleteCardBtn) deleteCardBtn.addEventListener('click', () => { const cardId = cardModalIdInput.value; const listId = cardModalListIdInput.value; showConfirmation('Delete Card', 'Are you sure you want to permanently delete this card? This action cannot be undone.', () => { const board = getCurrentBoard(); if(!board) return; const list = board.lists.find(l => l.id === listId); const cardToDelete = list ? list.cards.find(c => c.id === cardId) : board.archivedCards?.find(c => c.id === cardId); if(list) list.cards = list.cards.filter(c => c.id !== cardId); if (board.archivedCards) board.archivedCards = board.archivedCards.filter(c => c.id !== cardId); if (cardToDelete) logActivity(board.id, `Card "${cardToDelete.title}" permanently deleted.`); saveState(); if(list) renderCards(listId); closeModal('cardDetailsModal'); if (cardToDelete) showMessage("Card Deleted", `Card "${cardToDelete.title}" has been permanently deleted.`); }); });

            // --- Archived Cards ---
            if(viewArchivedCardsBtn) viewArchivedCardsBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) { showMessage("Error", "Please select a board."); return; } if(archivedCardsModalTitle) archivedCardsModalTitle.textContent = `Archived Cards: ${board.name}`; renderArchivedCards(); openModal('archivedCardsModal'); });
            const renderArchivedCards = () => { if (!archivedCardsListContainer) return; const board = getCurrentBoard(); archivedCardsListContainer.innerHTML = ''; if (!board || !board.archivedCards || board.archivedCards.length === 0) { archivedCardsListContainer.innerHTML = '<p>No archived cards for this board.</p>'; return; } board.archivedCards.forEach(card => { const itemEl = document.createElement('div'); itemEl.classList.add('archived-card-item'); itemEl.innerHTML = `<div class="archived-card-info"><strong>${card.title}</strong><small>(Archived: ${new Date(card.archivedAt || card.lastModified).toLocaleDateString()})</small></div><button class="btn btn-secondary btn-sm restore-archived-card-btn" data-card-id="${card.id}">Restore</button>`; const restoreBtn = itemEl.querySelector('.restore-archived-card-btn'); if(restoreBtn) restoreBtn.addEventListener('click', (e) => { restoreCard(e.target.dataset.cardId); }); archivedCardsListContainer.appendChild(itemEl); }); };
            const restoreCard = (cardId) => { const board = getCurrentBoard(); if (!board || !board.archivedCards) return; const cardIndex = board.archivedCards.findIndex(c => c.id === cardId); if (cardIndex === -1) return; const [cardToRestore] = board.archivedCards.splice(cardIndex, 1); cardToRestore.archived = false; delete cardToRestore.archivedAt; cardToRestore.lastModified = new Date().toISOString(); cardToRestore.notifiedOverdue = false; let targetList = board.lists.find(l => l.id === cardToRestore.originalListIdBeforeArchive); if (!targetList && board.lists.length > 0) targetList = board.lists[0];  if (targetList) { targetList.cards.push(cardToRestore); logActivity(board.id, `Card "${cardToRestore.title}" restored to list "${targetList.name}".`); saveState(); renderLists(); renderArchivedCards();  showMessage("Card Restored", `Card "${cardToRestore.title}" has been restored.`); } else { board.archivedCards.push(cardToRestore);  showMessage("Error", "Could not restore card: No target list found. Ensure lists exist."); } };

            // --- Filter Logic and UI ---
            const getUniqueLabelsForBoard = (board) => { if (!board) return []; const allLabels = new Map(); board.lists.forEach(list => { list.cards.forEach(card => { if (card.labels) { card.labels.forEach(label => { if (label.name && !allLabels.has(label.name.toLowerCase())) { allLabels.set(label.name.toLowerCase(), { name: label.name, color: getLabelColor(label.color || label.name) }); } }); } }); }); return Array.from(allLabels.values()); };
            const getUniqueAssigneesForBoard = (board) => { if (!board) return []; const allAssignees = new Set(); board.lists.forEach(list => { list.cards.forEach(card => { if (card.assignedUsers) { card.assignedUsers.forEach(user => allAssignees.add(user)); } }); }); return Array.from(allAssignees).sort(); };
            const populateFilterOptions = () => { const board = getCurrentBoard(); if (!board || !filterModal) return; if (filterLabelsContainer) { filterLabelsContainer.innerHTML = ''; const uniqueLabels = getUniqueLabelsForBoard(board); if (uniqueLabels.length > 0) { uniqueLabels.forEach(labelObj => { const labelEl = document.createElement('label'); const isChecked = (board.filters.labels || []).includes(labelObj.name); labelEl.innerHTML = `<input type="checkbox" value="${labelObj.name}" ${isChecked ? 'checked' : ''}><span class="label-color-swatch" style="background-color: ${labelObj.color};"></span>${labelObj.name}`; filterLabelsContainer.appendChild(labelEl); }); } else { filterLabelsContainer.innerHTML = '<p><small>No labels found on this board.</small></p>'; } } if (filterAssigneesContainer) { filterAssigneesContainer.innerHTML = ''; const uniqueAssignees = getUniqueAssigneesForBoard(board); if (uniqueAssignees.length > 0) { uniqueAssignees.forEach(assigneeName => { const assigneeEl = document.createElement('label'); const isChecked = (board.filters.assignees || []).includes(assigneeName); assigneeEl.innerHTML = `<input type="checkbox" value="${assigneeName}" ${isChecked ? 'checked' : ''}>${assigneeName}`; filterAssigneesContainer.appendChild(assigneeEl); }); } else { filterAssigneesContainer.innerHTML = '<p><small>No assignees found on this board.</small></p>'; } } if(filterText) filterText.value = board.filters.text || ''; if(filterDueDateSelect) filterDueDateSelect.value = board.filters.dueDate || 'any'; };
            function cardMatchesFilters(card, filters, board) { if (!filters) return true;  if (filters.text) { const searchText = filters.text.toLowerCase(); if (!(card.title.toLowerCase().includes(searchText) || (card.description && card.description.toLowerCase().includes(searchText)))) { return false; } } if (filters.labels && filters.labels.length > 0) { if (!card.labels || card.labels.length === 0) return false;  const cardLabelNames = card.labels.map(l => l.name.toLowerCase()); if (!filters.labels.some(flName => cardLabelNames.includes(flName.toLowerCase()))) { return false; } } if (filters.assignees && filters.assignees.length > 0) { if (!card.assignedUsers || card.assignedUsers.length === 0) return false; const cardAssigneesLower = card.assignedUsers.map(u => u.toLowerCase()); if (!filters.assignees.some(faName => cardAssigneesLower.includes(faName.toLowerCase()))) { return false; } } if (filters.dueDate && filters.dueDate !== 'any') { const now = new Date(); const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()); const cardDueDate = card.dueDate ? new Date(card.dueDate) : null; switch (filters.dueDate) { case 'noDate': if (cardDueDate) return false; break; case 'overdue': if (!cardDueDate || cardDueDate >= todayStart) return false; break; case 'dueToday': const todayEnd = new Date(todayStart.getTime() + (24 * 60 * 60 * 1000 -1)); if (!cardDueDate || cardDueDate < todayStart || cardDueDate > todayEnd) return false; break; case 'dueTomorrow': const tomorrowStart = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000); const tomorrowEnd = new Date(tomorrowStart.getTime() + (24 * 60 * 60 * 1000 -1)); if (!cardDueDate || cardDueDate < tomorrowStart || cardDueDate > tomorrowEnd) return false; break; case 'dueNext7Days':  const sevenDaysLaterEnd = new Date(todayStart.getTime() + 7 * 24 * 60 * 60 * 1000 -1); if (!cardDueDate || cardDueDate < todayStart || cardDueDate > sevenDaysLaterEnd) return false; break; } } return true;  }
            const updateFilterButtonState = () => { if (!filterCardsBtn) return; const board = getCurrentBoard(); let filtersActive = false; if (board && board.filters) { if (board.filters.text || (board.filters.labels && board.filters.labels.length > 0) || (board.filters.assignees && board.filters.assignees.length > 0) || (board.filters.dueDate && board.filters.dueDate !== 'any')) { filtersActive = true; } } if (filtersActive) { filterCardsBtn.classList.add('filter-active'); filterCardsBtn.title = "Filters Active"; } else { filterCardsBtn.classList.remove('filter-active'); filterCardsBtn.title = "Filter Cards"; } };
            if (filterCardsBtn) { filterCardsBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) { showMessage("Error", "Please select a board to set filters."); return; } populateFilterOptions(); openModal('filterModal'); }); }
            if (applyFiltersBtn) { applyFiltersBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) return; board.filters.text = filterText ? filterText.value.trim() : ''; board.filters.labels = []; if (filterLabelsContainer) { filterLabelsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => { board.filters.labels.push(cb.value); }); } board.filters.assignees = []; if (filterAssigneesContainer) { filterAssigneesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => { board.filters.assignees.push(cb.value); }); } board.filters.dueDate = filterDueDateSelect ? filterDueDateSelect.value : 'any'; logActivity(board.id, "Card filters applied."); saveState(); renderLists(); updateFilterButtonState(); closeModal('filterModal'); }); }
            if (clearFiltersBtn) { clearFiltersBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) return; board.filters = { text: '', labels: [], assignees: [], dueDate: 'any' }; if(filterText) filterText.value = ''; if(filterDueDateSelect) filterDueDateSelect.value = 'any'; if (filterLabelsContainer) filterLabelsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); if (filterAssigneesContainer) filterAssigneesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); logActivity(board.id, "Card filters cleared."); saveState(); renderLists(); updateFilterButtonState(); closeModal('filterModal'); }); }

            // --- View Switching & Other Views ---
            const switchView = (viewName) => { Object.values(views).forEach(view => { if(view) view.classList.remove('active');}); if (views[viewName]) { views[viewName].classList.add('active'); const board = getCurrentBoard(); if (board) { if(calendarBoardTitle) calendarBoardTitle.textContent = `Calendar: ${board.name}`; if(tableBoardTitle) tableBoardTitle.textContent = `Table: ${board.name}`; if(analyticsBoardTitle) analyticsBoardTitle.textContent = `Analytics: ${board.name}`; if (viewName === 'calendar') renderCalendarView(); if (viewName === 'table') renderTableView(); if (viewName === 'analytics') renderAnalyticsView(); } else if (viewName !== 'kanban') { showMessage("No Board", "Please select a board to see this view."); switchView('kanban'); } } };
            [viewCalendarBtn, viewTableBtn, viewAnalyticsBtn, backToKanbanFromCalendarBtn, backToKanbanFromTableBtn, backToKanbanFromAnalyticsBtn].forEach(btn => { if (btn) { btn.addEventListener('click', (e) => { if (e.target === viewCalendarBtn) switchView('calendar'); else if (e.target === viewTableBtn) switchView('table'); else if (e.target === viewAnalyticsBtn) switchView('analytics'); else switchView('kanban'); }); } });
            const calendarGrid = document.getElementById('calendarGrid'); const currentMonthYearEl = document.getElementById('currentMonthYear'); const prevMonthBtn = document.getElementById('prevMonthBtn'); const nextMonthBtn = document.getElementById('nextMonthBtn');
            function renderCalendarView() { const board = getCurrentBoard(); if (!board || !calendarGrid || !currentMonthYearEl) return; calendarGrid.innerHTML = '';  currentMonthYearEl.textContent = calendarDate.toLocaleDateString('default', { month: 'long', year: 'numeric' }); const year = calendarDate.getFullYear(); const month = calendarDate.getMonth(); const firstDayOfMonth = new Date(year, month, 1); const lastDayOfMonth = new Date(year, month + 1, 0); const daysInMonth = lastDayOfMonth.getDate(); const startingDayOfWeek = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() -1; const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; dayNames.forEach(name => { const dayHeaderEl = document.createElement('div'); dayHeaderEl.classList.add('calendar-day-header'); dayHeaderEl.textContent = name; calendarGrid.appendChild(dayHeaderEl); }); for (let i = 0; i < startingDayOfWeek; i++) { calendarGrid.appendChild(document.createElement('div')).classList.add('calendar-day'); } for (let day = 1; day <= daysInMonth; day++) { const dayEl = document.createElement('div'); dayEl.classList.add('calendar-day'); const currentDateObj = new Date(year, month, day); if (isToday(currentDateObj)) { dayEl.classList.add('today'); } dayEl.innerHTML = `<div class="date-number">${day}</div>`;  board.lists.forEach(list => { list.cards.forEach(card => { if (card.dueDate && !card.archived) { try { const dueDate = new Date(card.dueDate); if (dueDate.getFullYear() === year && dueDate.getMonth() === month && dueDate.getDate() === day) { const cardItemEl = document.createElement('div'); cardItemEl.classList.add('calendar-card-item'); cardItemEl.textContent = card.title; cardItemEl.title = card.title; cardItemEl.style.backgroundColor = getLabelColor(card.labels?.[0]?.color || card.labels?.[0]?.name || 'blue'); cardItemEl.addEventListener('click', () => openCardDetails(card.id, list.id)); dayEl.appendChild(cardItemEl); } } catch(e) { console.error("Error processing card for calendar:", card.title, e); } } }); }); calendarGrid.appendChild(dayEl); } }
            if(prevMonthBtn) prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendarView(); });
            if(nextMonthBtn) nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendarView(); });
            const tableHeaderRow = document.getElementById('tableHeaderRow'); const tableBody = document.getElementById('tableBody'); let tableSortState = { column: 'title', direction: 'asc' };
            function renderTableView() { const board = getCurrentBoard(); if (!board || !tableHeaderRow || !tableBody) return; tableHeaderRow.innerHTML = ''; tableBody.innerHTML = ''; const columns = [ { key: 'title', name: 'Title' }, { key: 'listName', name: 'List' }, { key: 'dueDate', name: 'Due Date' }, { key: 'priority', name: 'Priority' }, { key: 'assignedUsers', name: 'Assignees' }, { key: 'labels', name: 'Labels' }, ]; columns.forEach(col => { const th = document.createElement('th'); th.textContent = col.name; th.dataset.sortKey = col.key; th.addEventListener('click', () => { tableSortState.direction = (tableSortState.column === col.key && tableSortState.direction === 'asc') ? 'desc' : 'asc'; tableSortState.column = col.key; renderTableView();  }); if (tableSortState.column === col.key) { th.textContent += tableSortState.direction === 'asc' ? ' ▲' : ' ▼'; } tableHeaderRow.appendChild(th); }); let allCards = []; board.lists.forEach(list => { list.cards.forEach(card => { if (!card.archived) { allCards.push({ ...card, listName: list.name, listId: list.id });  } }); }); if (tableSortState.column) { allCards.sort((a, b) => { let valA = a[tableSortState.column]; let valB = b[tableSortState.column]; if (tableSortState.column === 'dueDate') { valA = valA ? new Date(valA).getTime() : 0; valB = valB ? new Date(valB).getTime() : 0; } else if (Array.isArray(valA)) valA = valA.map(v => typeof v === 'object' ? v.name : v).join(', ').toLowerCase(); else if (typeof valA === 'string') valA = valA.toLowerCase(); if (Array.isArray(valB)) valB = valB.map(v => typeof v === 'object' ? v.name : v).join(', ').toLowerCase(); else if (typeof valB === 'string') valB = valB.toLowerCase(); if (valA === null || valA === undefined) valA = ""; if (valB === null || valB === undefined) valB = ""; if (valA < valB) return tableSortState.direction === 'asc' ? -1 : 1; if (valA > valB) return tableSortState.direction === 'asc' ? 1 : -1; return 0; }); } allCards.forEach(card => { const tr = document.createElement('tr'); tr.dataset.cardId = card.id; tr.dataset.listId = card.listId; tr.style.cursor = 'pointer'; tr.addEventListener('click', () => openCardDetails(card.id, card.listId)); columns.forEach(col => { const td = document.createElement('td'); let value = card[col.key]; if (col.key === 'dueDate' && value) value = new Date(value).toLocaleDateString(); else if (Array.isArray(value)) value = value.map(v => typeof v === 'object' ? v.name : v).join(', '); td.textContent = value !== undefined && value !== null ? String(value) : ''; tr.appendChild(td); }); tableBody.appendChild(tr); }); }
            const tasksPerListChartEl = document.getElementById('tasksPerListChart');
            function renderAnalyticsView() { const board = getCurrentBoard(); if (!board || !tasksPerListChartEl) return; tasksPerListChartEl.innerHTML = '';  const listNames = board.lists.map(list => list.name); const tasksCount = board.lists.map(list => list.cards.filter(c => !c.archived).length); const maxTasks = Math.max(...tasksCount, 1);  const colors = ['#0079bf', '#61bd4f', '#f2d600', '#ff9f1a', '#c377e0', '#eb5a46', '#344563', '#ff78cb']; listNames.forEach((name, index) => { const barHeightPercentage = (tasksCount[index] / maxTasks) * 100; const barEl = document.createElement('div'); barEl.classList.add('bar'); barEl.style.height = `${barHeightPercentage}%`; barEl.style.backgroundColor = colors[index % colors.length]; barEl.title = `${name}: ${tasksCount[index]} tasks`; barEl.innerHTML = `<span class="bar-value">${tasksCount[index]}</span><span class="bar-label">${name}</span>`; tasksPerListChartEl.appendChild(barEl); }); }

            // --- Settings Modal Functions ---
            if(settingsBtn) settingsBtn.addEventListener('click', () => { updateNotificationsButton(); updateLocalStorageUsage(); openModal('settingsModal'); });
            if(boardExportBtn) boardExportBtn.addEventListener('click', () => { const board = getCurrentBoard(); if (!board) { showMessage("Export Error", "No board selected to export."); return; } try { const jsonData = JSON.stringify(board, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${board.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_board_export.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch (e) { console.error("Error exporting board:", e); showMessage("Export Error", "Could not export board data."); } });
            if(boardImportBtn) boardImportBtn.addEventListener('click', () => { if (!boardImportInput || !boardImportInput.files || boardImportInput.files.length === 0) { showMessage("Import Error", "Please select a JSON file to import."); return; } const file = boardImportInput.files[0]; const reader = new FileReader(); reader.onload = (e) => { try { const importedBoard = JSON.parse(e.target.result); if (importedBoard && importedBoard.id && importedBoard.name && Array.isArray(importedBoard.lists)) { const existingBoardIndex = appData.boards.findIndex(b => b.id === importedBoard.id); if (existingBoardIndex > -1) { showConfirmation("Confirm Overwrite", `A board with ID "${importedBoard.id}" (${appData.boards[existingBoardIndex].name}) already exists. Overwrite it?`, () => { appData.boards[existingBoardIndex] = importedBoard; if(!importedBoard.filters) importedBoard.filters = { text: '', labels: [], assignees: [], dueDate: 'any' }; finalizeImport(importedBoard.id, `Board "${importedBoard.name}" overwritten successfully.`); }); } else { appData.boards.push(importedBoard); if(!importedBoard.filters) importedBoard.filters = { text: '', labels: [], assignees: [], dueDate: 'any' }; finalizeImport(importedBoard.id, `Board "${importedBoard.name}" imported successfully.`); } } else { showMessage("Import Error", "Invalid board file format."); } } catch (err) { console.error("Error importing board:", err); showMessage("Import Error", "Error importing board. Ensure the file is a valid BoardMaster JSON export."); } finally { if(boardImportInput) boardImportInput.value = '';  } }; reader.onerror = () => showMessage("File Read Error", "Could not read the selected file."); reader.readAsText(file); });
            function finalizeImport(boardIdToSelect, successMessage) { const importedBoard = appData.boards.find(b => b.id === boardIdToSelect); if (importedBoard) { appData.nextId.board = Math.max(appData.nextId.board, parseInt(importedBoard.id.split('-').pop()) + 1 || appData.nextId.board); importedBoard.lists.forEach(l => { appData.nextId.list = Math.max(appData.nextId.list, parseInt(l.id.split('-').pop()) + 1 || appData.nextId.list); l.cards.forEach(c => { appData.nextId.card = Math.max(appData.nextId.card, parseInt(c.id.split('-').pop()) + 1 || appData.nextId.card); }); }); } saveState(); renderBoardSelector(); selectBoard(boardIdToSelect);  showMessage("Import Successful", successMessage); }
            if(exportAllBoardsBtn) exportAllBoardsBtn.addEventListener('click', () => { if (appData.boards.length === 0) { showMessage("Export Error", "No boards to export."); return; } try { const exportData = { boards: appData.boards, settings: { theme: appData.settings.theme, notificationsEnabled: appData.settings.notificationsEnabled }, nextId: appData.nextId }; const jsonData = JSON.stringify(exportData, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `boardmaster_all_boards_export.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch (e) {  console.error("Error exporting all boards:", e); showMessage("Export Error", "Could not export all boards data."); } });
            if(importAllBoardsBtn) importAllBoardsBtn.addEventListener('click', () => {  if (!importAllBoardsInput || !importAllBoardsInput.files || importAllBoardsInput.files.length === 0) { showMessage("Import Error", "Please select a JSON file to import."); return; } const file = importAllBoardsInput.files[0]; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData && Array.isArray(importedData.boards) && importedData.settings && importedData.nextId) { showConfirmation("Confirm Import All", "This will replace ALL current boards and settings. This action cannot be undone. Are you sure?", () => { appData.boards = importedData.boards; appData.settings.theme = importedData.settings.theme || 'light'; appData.settings.notificationsEnabled = importedData.settings.notificationsEnabled || false; appData.nextId = importedData.nextId; appData.boards.forEach(b => { if(!b.filters) b.filters = {text:'', labels:[], assignees:[], dueDate:'any'};}); appData.settings.currentBoardId = appData.boards.length > 0 ? appData.boards[0].id : null;  saveState(); applyTheme(appData.settings.theme); updateNotificationsButton(); renderBoardSelector(); selectBoard(appData.settings.currentBoardId); switchView('kanban'); showMessage("Import Successful", "All boards and settings imported successfully."); }); } else { showMessage("Import Error", "Invalid 'all boards' file format."); } } catch (err) { console.error("Error importing all boards:", err); showMessage("Import Error", "Error importing data. Ensure the file is a valid BoardMaster all boards JSON export."); } finally { if(importAllBoardsInput) importAllBoardsInput.value = '';  } }; reader.onerror = () => showMessage("File Read Error", "Could not read the selected file."); reader.readAsText(file); });
            if(clearAllDataBtn) clearAllDataBtn.addEventListener('click', () => { showConfirmation('Clear All Data', 'WARNING: This will delete all boards, lists, cards, and settings. This action cannot be undone. Are you absolutely sure?', () => { try { localStorage.removeItem('boardMasterData'); appData = { boards: [], settings: { currentBoardId: null, theme: 'light', notificationsEnabled: false }, nextId: { board: 1, list: 1, card: 1, checklist: 1, checklistItem: 1, comment: 1, attachment: 1, customFieldDef: 1 } }; saveState();  applyTheme(appData.settings.theme); updateNotificationsButton(); renderBoardSelector(); selectBoard(null); switchView('kanban');  if(welcomeScreen) welcomeScreen.classList.remove('hidden'); showMessage("Data Cleared", "All data has been cleared."); } catch (e) { console.error("Error clearing data:", e); showMessage("Error", "Could not clear all data."); } }); });

            // --- Initialization ---
            const init = async () => {
                loadState();
                applyTheme(appData.settings.theme || 'light');
                updateNotificationsButton(); 
                if (appData.settings.notificationsEnabled && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    // For a better UX, one might automatically try to request permission here if it was previously enabled.
                    // However, browsers often restrict requests outside direct user interaction.
                    // So, the button state reflecting "Enable" if permission is 'default' is reasonable.
                }
                renderBoardSelector();
                if (appData.settings.currentBoardId && appData.boards.find(b => b.id === appData.settings.currentBoardId)) {
                    selectBoard(appData.settings.currentBoardId);
                } else if (appData.boards.length > 0) {
                    appData.settings.currentBoardId = appData.boards[0].id;
                    selectBoard(appData.settings.currentBoardId);
                } else {
                    if(welcomeScreen) welcomeScreen.classList.remove('hidden');
                    if(currentBoardTitleEl) currentBoardTitleEl.textContent = 'No Board Selected';
                    [addListBtn, viewCalendarBtn, viewTableBtn, viewAnalyticsBtn, boardActivityLogBtn, viewArchivedCardsBtn, filterCardsBtn].forEach(btn => { if(btn) btn.disabled = true; });
                }
                updateLocalStorageUsage();
                switchView('kanban'); 
                setInterval(checkOverdueCardsAndNotify, 60000); 

                // Global click listener for closing list dropdowns
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.list-menu-btn') && !e.target.closest('.list-dropdown-menu.active')) {
                        document.querySelectorAll('.list-dropdown-menu.active').forEach(menu => {
                            menu.classList.remove('active');
                        });
                    }
                });
            };

            if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); } 
            else { init(); }

        })();
    </script>
</body>
</html>
